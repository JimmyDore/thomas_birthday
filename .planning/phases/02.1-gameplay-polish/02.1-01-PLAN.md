---
phase: 02.1-gameplay-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [game.js]
autonomous: true

must_haves:
  truths:
    - "Watch brand names (Montignac vs fakes) are clearly legible on mobile during gameplay, even on rotating moving watches"
    - "Most players finish with a negative score -- positive score requires careful reading and selective slashing"
    - "Best score persists across browser sessions and is displayed on both start and game over screens"
    - "New best score is celebrated on game over screen when achieved"
  artifacts:
    - path: "game.js"
      provides: "All gameplay polish: brand visibility, difficulty rebalance, localStorage high scores"
      contains: "strokeText.*strokeStyle.*#ffffff"
  key_links:
    - from: "saveBestScore()"
      to: "localStorage.setItem()"
      via: "try-catch wrapped JSON serialization"
      pattern: "localStorage\\.setItem.*JSON\\.stringify"
    - from: "renderStart()"
      to: "bestScore"
      via: "global variable read"
      pattern: "bestScore.*null"
    - from: "renderGameOver()"
      to: "bestScore"
      via: "global variable read + isNewBest flag"
      pattern: "bestScore.*null"
---

<objective>
Polish gameplay across three dimensions: make watch brand names clearly readable on mobile so players can distinguish real Montignac from fakes, rebalance difficulty so positive scores feel like a real achievement, and persist best scores in localStorage with display on both screens.

Purpose: The game is fully functional but brand names are too small to read on mobile (defeating the core mechanic of spotting fakes), the economy is too generous (everyone wins easily), and scores don't persist between sessions.

Output: Updated game.js with enhanced brand label rendering, rebalanced difficulty parameters, and localStorage high score persistence.
</objective>

<execution_context>
@/Users/jimmydore/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jimmydore/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02.1-gameplay-polish/02.1-RESEARCH.md
@game.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance brand label readability with stroke outline and larger font</name>
  <files>game.js</files>
  <action>
Replace the `drawBrandLabel()` function (currently at ~line 843) with an enhanced version that uses `strokeText` + `fillText` for contrast:

```javascript
function drawBrandLabel(ctx, brand, r, size) {
  var fontSize = Math.max(11, size * 0.22);
  ctx.font = 'bold ' + fontSize + 'px sans-serif';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  // Stroke first (outline), then fill -- standard Canvas text outline technique
  ctx.lineWidth = 2.5;
  ctx.strokeStyle = '#ffffff';
  ctx.strokeText(brand, 0, r * 0.3);
  ctx.fillStyle = '#333';
  ctx.fillText(brand, 0, r * 0.3);
}
```

Key changes:
- Font size multiplier increased from 0.18 to 0.22 (~13px on 60px watch, ~16px on golden 72px watch)
- Minimum font size raised from 10 to 11
- White stroke outline (lineWidth 2.5) drawn BEFORE fill for clean edge contrast
- strokeText() before fillText() is critical -- reverse order makes text look embossed

Do NOT change WATCH_SIZE, watch position, or any other rendering code. Only the `drawBrandLabel` function changes.
  </action>
  <verify>
Open index.html on mobile Chrome (or Chrome DevTools mobile emulator at 375x667). Start a game. Verify:
1. Brand names are clearly readable on all three watch styles (round, square, sport)
2. White outline creates good contrast against both cream dial and colored case
3. Text is not bloated or merging between characters (lineWidth 2.5 is subtle, not thick)
4. Golden watches also have readable labels at their larger size
  </verify>
  <done>Brand names "Montignac" and all fake names are clearly legible on mobile during gameplay on all watch styles, with white stroke outline providing edge contrast.</done>
</task>

<task type="auto">
  <name>Task 2: Rebalance difficulty to make positive scores extremely hard</name>
  <files>game.js</files>
  <action>
Adjust multiple numeric parameters across existing functions in game.js:

**1. getDifficulty() function (~line 172)** -- Update the four return values:
```javascript
function getDifficulty() {
  var t = Math.min(1, elapsed / ROUND_DURATION);
  var tEased = t * t;
  return {
    spawnInterval: Math.max(0.3, 1.2 - tEased * 0.9),  // 1.2s -> 0.3s (was 0.4s floor)
    speedMultiplier: 1.0 + t * 0.8,                      // 1.0x -> 1.8x (was 1.4x)
    fakeChance: 0.20 + t * 0.45,                          // 20% -> 65% (was 15%->55%)
    sneakyChance: 0.15 + t * 0.45                          // 15% -> 60% (was 10%->50%)
  };
}
```

**2. spawnWatch() function (~line 214)** -- Change the watchValue assignment:
```javascript
var watchValue = isGolden ? 50 : (isFake ? -15 : 10);  // was -8 / +15
```
Real watch reward reduced from +15 to +10. Fake penalty increased from -8 to -15.

**3. updateWatches() function (~line 250 and ~line 265)** -- Change BOTH miss penalty instances from -5 to -8:
```javascript
score -= 8;  // was -5 (appears twice: bottom-exit and side-exit)
```
Update both the bottom-exit penalty (line ~250) and the side-exit penalty (line ~265). Also update both corresponding `spawnFloatingText` calls to show -8 instead of -5.

**Economy shift summary:**
- Real slash: +10 (was +15) -- less reward per good slash
- Fake slash: -15 (was -8) -- nearly double penalty for careless slashing
- Miss real: -8 (was -5) -- stronger punishment for passive play
- Fake ratio: 20%->65% (was 15%->55%) -- more traps at all times
- Sneaky ratio: 15%->60% (was 10%->50%) -- sneaky fakes appear earlier and more often
- Speed: 1.0x->1.8x (was 1.4x) -- faster late-game watches
- Spawn floor: 0.3s (was 0.4s) -- slightly tighter spawn rate at end

Expected net for average player: ~-185 (was ~+356). Only careful readers who avoid fakes and catch most real watches will go positive.

Do NOT change combo multiplier thresholds, golden watch spawn rate, rating tiers, or any rendering logic.
  </action>
  <verify>
Open index.html and play a full 60-second round. Verify:
1. Early game (0-20s) feels manageable but already has occasional fakes
2. Mid game (20-40s) has noticeably more fakes and sneaky fakes
3. Late game (40-60s) is chaotic with fast watches and majority fakes
4. A casual play-through likely ends with a negative score
5. Floating text shows -8 for missed watches (not -5)
6. Floating text shows -15 for slashed fakes (not -8)
  </verify>
  <done>Game economy is rebalanced so that most players finish with a negative score. Positive score requires careful reading of brand names and selective slashing. All difficulty parameters are updated in getDifficulty(), spawnWatch(), and updateWatches().</done>
</task>

<task type="auto">
  <name>Task 3: Add localStorage high score persistence with display on both screens</name>
  <files>game.js</files>
  <action>
Add three components to game.js:

**1. High score persistence functions** -- Add near the top of the file, after the game state variables (~line 21, after `let lastTime = 0;`):

```javascript
// --- High Score Persistence ---
var STORAGE_KEY = 'watchNinja_bestScore';
var bestScore = null;
var isNewBest = false;

function loadBestScore() {
  try {
    var stored = localStorage.getItem(STORAGE_KEY);
    if (stored !== null) {
      var parsed = JSON.parse(stored);
      if (typeof parsed === 'number' && isFinite(parsed)) {
        return parsed;
      }
    }
  } catch (e) { /* localStorage unavailable or corrupted -- fail silently */ }
  return null;
}

function saveBestScore(newScore) {
  try {
    if (bestScore === null || newScore > bestScore) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(newScore));
      bestScore = newScore;
      return true;
    }
  } catch (e) { /* localStorage unavailable -- fail silently */ }
  return false;
}
```

**2. Hook into game lifecycle:**

- In the initialization section at the bottom of game.js (~line 1317, after `initCanvas();`), add:
  ```javascript
  bestScore = loadBestScore();
  ```

- In `update()` function where game ends (~line 1248, inside `if (elapsed >= ROUND_DURATION)`), add BEFORE setting gameState to 'over':
  ```javascript
  isNewBest = saveBestScore(score);
  gameState = 'over';
  return;
  ```

- In `resetGame()` function, add:
  ```javascript
  isNewBest = false;
  ```

**3. Display on start screen** -- In `renderStart()`, after the subtitle line (`ctx.fillText('Thomas, prouve que tu es le roi !'...)`), add:
```javascript
if (bestScore !== null) {
  ctx.font = 'bold 16px sans-serif';
  ctx.fillStyle = '#FFD700';
  ctx.textAlign = 'center';
  ctx.fillText('Meilleur score : ' + (bestScore >= 0 ? '+' : '') + bestScore + '\u20AC', canvasWidth / 2, canvasHeight * 0.25 + 70);
}
```

**4. Display on game over screen** -- In `renderGameOver()`, insert AFTER the max combo block and BEFORE the Vinted rating verdict section (before `var rating = getRating(score);` around line 1158). Add:
```javascript
// Best score display
if (bestScore !== null) {
  ctx.font = 'bold 18px sans-serif';
  ctx.fillStyle = '#FFD700';
  ctx.fillText('Record : ' + (bestScore >= 0 ? '+' : '') + bestScore + '\u20AC', cx, lineY);
  lineY += lineGap;
}
if (isNewBest) {
  ctx.font = 'bold 16px sans-serif';
  ctx.fillStyle = '#50e880';
  ctx.fillText('Nouveau record !', cx, lineY);
  lineY += lineGap;
}
```

All localStorage calls MUST be wrapped in try-catch. The game must work identically if localStorage is unavailable (private browsing, disabled storage). Do NOT add a top-N leaderboard or name entry -- single best score only.
  </action>
  <verify>
1. Play a full round. After game over, check that the score is saved: open browser DevTools > Application > Local Storage > look for key `watchNinja_bestScore`
2. Return to start screen (replay then check start). Verify "Meilleur score : +X€" or "Meilleur score : -X€" appears below the subtitle
3. On game over screen, verify "Record : +X€" appears in the stats section
4. Play again and get a worse score. Verify the best score does NOT update (old record remains)
5. Play again and beat the record. Verify "Nouveau record !" appears in green on game over
6. Close the browser tab entirely. Reopen index.html. Verify the best score is still displayed on the start screen (persistence works)
7. Open in a private/incognito window. Verify the game works normally without errors (no best score displayed, which is correct)
  </verify>
  <done>Best score is saved in localStorage after each game, displayed on both start and game over screens. New records show "Nouveau record !" celebration text. The game works identically without localStorage (private browsing). Single best score, no top-N list.</done>
</task>

</tasks>

<verification>
After all three tasks are complete, verify the full phase success criteria:

1. **Brand visibility**: Start a game on mobile (or Chrome DevTools 375x667). Watch brand names are clearly readable on all watch styles during gameplay. The white stroke outline makes text legible against the cream dial and colored cases.

2. **Brutal difficulty**: Play a full 60-second round casually (slash everything). Score should be significantly negative. Play carefully (read names, avoid fakes). Score should still be hard to keep positive. Only skilled, attentive play yields a positive score.

3. **localStorage persistence**: Best score appears on start screen after first play. Best score appears on game over screen. New records are celebrated. Scores persist across browser sessions. Game works in private browsing without errors.
</verification>

<success_criteria>
- drawBrandLabel() uses strokeText + fillText with white outline, font size multiplier 0.22
- getDifficulty() returns fakeChance 0.20->0.65, sneakyChance 0.15->0.60, speedMultiplier 1.0->1.8, spawnInterval floor 0.3
- Real watch value is +10, fake penalty is -15, miss penalty is -8
- loadBestScore() and saveBestScore() exist with try-catch wrappers
- bestScore displayed on start screen below subtitle
- bestScore and isNewBest displayed on game over screen before rating
- All changes contained within game.js, no new files created
</success_criteria>

<output>
After completion, create `.planning/phases/02.1-gameplay-polish/02.1-01-SUMMARY.md`
</output>
