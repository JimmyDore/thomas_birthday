---
phase: 06-buy-sell-mechanic
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [game.js]
autonomous: true

must_haves:
  truths:
    - "Act 1 plays identically to the current game but with spending/inventory HUD instead of profit display"
    - "Slashing any card in Act 1 adds it to inventory (real, fake, or golden)"
    - "When Act 1 timer ends, a transition screen shows inventory summary with fake reveal"
    - "Player taps 'Vendre !' to advance (no auto-advance)"
    - "If player bought zero watches, game skips to game over with special message"
  artifacts:
    - path: "game.js"
      provides: "Five-state game machine, inventory system, transition screen"
      contains: "act1"
  key_links:
    - from: "slashWatch"
      to: "inventory.push"
      via: "addToInventory call inside slashWatch when gameState is act1"
      pattern: "inventory\\.push"
    - from: "gameState === 'act1' timer end"
      to: "gameState = 'transition'"
      via: "elapsed >= ROUND_DURATION triggers transition"
      pattern: "gameState.*=.*transition"
    - from: "transition screen tap"
      to: "gameState = 'act2'"
      via: "vendreButton hit test starts Act 2"
      pattern: "gameState.*=.*act2"
---

<objective>
Refactor the game state machine from 3 states to 5, add inventory tracking to Act 1, create the transition screen between acts, and reframe Act 1's HUD as "Les Achats" (buying phase).

Purpose: This plan lays the foundation for two-act gameplay. Act 1 must work identically to the current game (same economy, physics, spawning) but with reframed display and inventory recording. The transition screen bridges Act 1 to Act 2.

Output: game.js with working Act 1 + transition screen. Act 2 will be a stub state (placeholder) wired up in Plan 02.
</objective>

<execution_context>
@/Users/jimmydore/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jimmydore/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-buy-sell-mechanic/06-CONTEXT.md
@.planning/phases/06-buy-sell-mechanic/06-RESEARCH.md
@game.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor state machine, input handlers, and game loop for five states</name>
  <files>game.js</files>
  <action>
Refactor the existing game.js to support 5 game states. This is a careful refactoring -- Act 1 must behave identically to the current "playing" state.

1. **State variable:** Change `gameState` comment from `'start' | 'playing' | 'over'` to `'start' | 'act1' | 'transition' | 'act2' | 'over'`. Do NOT rename the variable itself.

2. **New top-level variables** (add near existing game state vars around line 13-28):
   ```javascript
   var inventory = [];        // [{brand, price, isFake, isGolden, cost, sold, soldFor}]
   var act1Spending = 0;      // Total EUR spent in Act 1 (absolute values)
   var act2Revenue = 0;       // Total EUR earned in Act 2
   var ACT2_DURATION = 45;    // seconds
   var act2Elapsed = 0;
   var currentOfferIndex = 0; // Round-robin index for buyer offers
   ```

3. **Rename `update(dt)` to `updateAct1(dt)`** (around line 1356). Change the timer-end logic: instead of setting `gameState = 'over'`, set `gameState = 'transition'`. Remove the `saveBestScore` call from here (it moves to game-over in Plan 02).

4. **Rename `render(dt)` to `renderAct1(dt)`** (around line 1386). After the existing HUD calls (renderScore, renderTimer, renderCombo, renderRating), add calls to `renderAct1HUD()` which draws the act header and inventory counter.

5. **Modify `gameLoop`** (around line 1405): Replace `'playing'` branch with `'act1'` calling `updateAct1(dt)` and `renderAct1(dt)`. Add `'transition'` branch calling `renderTransition(dt)`. Add `'act2'` branch as a stub (just `renderBackground()` + text "Act 2 coming..." for now -- Plan 02 fills this in).

6. **Modify `startGame()`** (line 1330): Change `gameState = 'playing'` to `gameState = 'act1'`.

7. **Modify `setupInput()` pointerdown handler** (line 331): Where it checks `gameState === 'playing'`, change to check for both `'act1'` and `'act2'`. Add a `gameState === 'transition'` branch that calls `handleTransitionTap(px, py)`. Similarly update `pointermove` to allow both `'act1'` and `'act2'`.

8. **Modify `updateWatches(dt)`** (line 452): The miss penalty (score -= 8) should only apply during `gameState === 'act1'`. In Act 2, missed offers just fly away with no penalty (the penalty is unsold inventory at game end).

9. **Modify `slashWatch(watch, slashAngle)`** (line 599): Add inventory recording BEFORE the score update. When `gameState === 'act1'`, call `addToInventory(watch)` and add `Math.abs(watch.value)` to `act1Spending`. Keep all existing scoring, combo, particle, sound logic unchanged.

10. **Add `addToInventory(watch)` function:**
    ```javascript
    function addToInventory(watch) {
      inventory.push({
        brand: watch.brand,
        price: watch.price,
        isFake: watch.isFake,
        isGolden: watch.isGolden,
        cost: Math.abs(watch.value),
        sold: false,
        soldFor: 0
      });
    }
    ```

11. **Modify `resetGame()`** (line 1336): Add clearing of new variables:
    ```javascript
    inventory.length = 0;
    act1Spending = 0;
    act2Revenue = 0;
    act2Elapsed = 0;
    currentOfferIndex = 0;
    ```

12. **CRITICAL: Do NOT change the economy values.** Real = +10, fake = -15, miss = -8, golden = +50. The `score` variable still tracks Act 1 score (it will be repurposed in Plan 02).

Avoid breaking any existing rendering, physics, or sound systems. This is a refactoring task -- the game should play exactly the same as before for Act 1, just with the state name changed from 'playing' to 'act1'.
  </action>
  <verify>
Open index.html in browser. Tap "Jouer". The game should play exactly as before (cards fly, slash works, scoring works, timer counts down). When timer hits 0, instead of game-over screen, the game should enter transition state (may show stub/blank for now -- that is fine, Task 2 adds the transition screen). Check browser console for zero errors.
  </verify>
  <done>Game state machine uses 5 states. Act 1 plays identically to the previous "playing" state. slashWatch records inventory. resetGame clears all new variables. No regressions in Act 1 gameplay.</done>
</task>

<task type="auto">
  <name>Task 2: Add Act 1 HUD reframing and transition screen</name>
  <files>game.js</files>
  <action>
Build the Act 1 HUD overlay and the full transition screen between acts.

1. **Add `renderAct1HUD()` function** (called at end of `renderAct1`):
   - Draw "Acte 1 : Les Achats" header centered at top, below timer. Use `ctx.font = 'bold 14px sans-serif'`, color `'rgba(255,255,255,0.7)'`, positioned at `canvasWidth / 2, 55` (just below the timer which is at y=28).
   - Draw inventory counter at bottom-left or left side: `inventory.length + ' montre(s) achetee(s)'`. Use `ctx.font = '14px sans-serif'`, color `'rgba(255,255,255,0.8)'`, positioned around `(14, 80)`. Handle singular/plural with simple check.
   - Keep the existing `renderScore()` call -- it still shows the running score in Act 1 as the spending display. The CONTEXT.md says display as "Depense: X EUR" -- so modify `renderScore()` to check if `gameState === 'act1'` and show `'Depense: ' + act1Spending + ' EUR'` instead of the profit number. Use white text (not red/green conditional).
   - IMPORTANT: When `gameState !== 'act1'`, `renderScore()` should work as before (for Act 2 or any other state that calls it).

2. **Add transition screen variables:**
   ```javascript
   var vendreButton = { x: 0, y: 0, w: 200, h: 56 };
   ```

3. **Add `renderTransition(dt)` function:**
   - Clear canvas, render background.
   - "Acte 1 termine !" header at ~8% height, bold 24px, white.
   - "Depense totale : X EUR" at ~13% height, 18px, white. Use `act1Spending`.
   - Inventory list: render a simple text list of purchased watches. For each item in `inventory`, show the brand name and price. Use a compact layout -- ~16px font, 20px line spacing. Start at ~20% height. If more than 8 items, show first 7 + "... et N autres" to prevent overflow.
   - For each fake in the list, show the brand in red (#ff6666). For real brands, use white. For golden, use gold (#FFD700).
   - Fake reveal section at ~70% height: count fakes with `inventory.filter(function(item) { return item.isFake; }).length`. If > 0, display "Oups, N contrefacon(s) dans le lot !" in bold red (#ff6666). If 0, display "Aucune contrefacon, bien joue !" in green (#50e880).
   - "Vendre !" button at ~85% height. Use same visual style as startButton/replayButton (white rounded rect, #007782 text, bold 22px). Store in `vendreButton` variable.

4. **Add `handleTransitionTap(px, py)` function:**
   - Hit test against `vendreButton`. If hit, set `gameState = 'act2'`, reset `act2Elapsed = 0`, reset `spawnTimer = 0`, clear `watches.length = 0`, `splitHalves.length = 0`, `particles.length = 0`, `floatingTexts.length = 0`, `trailPoints.length = 0`, `lastTime = 0`. Also `combo = 0`, `comboMultiplier = 1`.
   - Edge case: if `inventory.length === 0`, skip to `gameState = 'over'` instead. Show "Aucune montre achetee ! Tu pars les mains vides..." message on transition screen and change button text to "Resultats" instead of "Vendre !".

5. **Wire transition tap into input handler:** The pointerdown handler should check `gameState === 'transition'` and call `handleTransitionTap(px, py)`.

All text must be in French as per project conventions.
  </action>
  <verify>
Open index.html. Play through Act 1 (slash some cards). When timer ends, transition screen should appear showing: header, spending total, inventory list with brand names colored appropriately, fake reveal message, and "Vendre !" button. Tapping "Vendre !" should clear the screen (Act 2 stub). Test edge case: let timer run without slashing anything -- should show empty inventory message. Check console for zero errors.
  </verify>
  <done>Act 1 displays "Acte 1 : Les Achats" header and inventory counter during gameplay. renderScore shows spending in Act 1. Transition screen shows full inventory, fake reveal, and "Vendre !" button. Empty inventory edge case handled. All text in French.</done>
</task>

</tasks>

<verification>
1. Open index.html on mobile Chrome (or mobile simulator)
2. Tap "Jouer" -- should see "Acte 1 : Les Achats" header and "0 montre(s) achetee(s)" counter
3. Slash several cards -- inventory counter increments, spending display updates
4. Let timer reach 0 -- transition screen appears with inventory list
5. Verify fake brands shown in red, real in white, golden in gold
6. Verify fake reveal message appears if any fakes were slashed
7. Tap "Vendre !" -- game enters Act 2 stub state (screen clears, shows stub text)
8. No console errors throughout
</verification>

<success_criteria>
- Five-state game machine works (start -> act1 -> transition -> act2 stub -> will be over in Plan 02)
- Act 1 gameplay is identical to previous "playing" state (same economy, physics, spawning)
- Every slashed card appears in inventory on transition screen
- Transition screen shows inventory summary, spending total, fake reveal, and "Vendre !" button
- Empty inventory edge case goes to game over
- All existing features (trail, particles, combos, sound, rating pill) still work in Act 1
</success_criteria>

<output>
After completion, create `.planning/phases/06-buy-sell-mechanic/06-01-SUMMARY.md`
</output>
