---
phase: 06-buy-sell-mechanic
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified: [game.js]
autonomous: false

must_haves:
  truths:
    - "Act 2 buyer cards fly in with blue/teal tint showing brand name, offer price, and directional hints"
    - "Swiping RIGHT on a buyer card accepts the offer (card splits, coin/penalty sound, revenue added)"
    - "Swiping LEFT on a buyer card rejects the offer (card flings left, 'Refuse' label)"
    - "Offers target specific unsold inventory items in round-robin order"
    - "Act 2 difficulty ramps via shrinking margins (not speed)"
    - "Act 2 ends when timer runs out OR all inventory is sold"
    - "Game over screen shows full breakdown: Act 1 spending, Act 2 revenue, unsold losses, final profit"
    - "Vinted seller rating reflects combined two-act performance"
  artifacts:
    - path: "game.js"
      provides: "Complete two-act gameplay with buyer offers, swipe direction, and redesigned game over"
      contains: "drawBuyerCardToCanvas"
  key_links:
    - from: "createBuyerOffer"
      to: "inventory[targetIndex]"
      via: "round-robin picks unsold inventory item for each offer"
      pattern: "targetIndex"
    - from: "getSwipeDirection"
      to: "checkAct2Collisions"
      via: "direction determines accept (right) vs reject (left)"
      pattern: "getSwipeDirection"
    - from: "acceptOffer"
      to: "inventory[].sold = true"
      via: "marks inventory item as sold and records soldFor"
      pattern: "invItem\\.sold.*=.*true"
    - from: "game over screen"
      to: "act2Revenue - act1Spending - unsoldLoss"
      via: "final profit calculated from inventory array at game over"
      pattern: "act2Revenue.*act1Spending"
---

<objective>
Implement Act 2 "La Revente" with buyer offer cards, directional swipe accept/reject, difficulty ramp via shrinking margins, and redesign the game over screen for two-act scoring breakdown.

Purpose: This plan completes the two-act gameplay loop. Act 2 gives the player a fundamentally different interaction (evaluate offers and swipe directionally) compared to Act 1's "slash everything" approach, creating the buy-then-sell depth described in the phase goal.

Output: Fully playable two-act game with complete game over screen, best score persistence, and Vinted seller rating reflecting both acts.
</objective>

<execution_context>
@/Users/jimmydore/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jimmydore/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-buy-sell-mechanic/06-CONTEXT.md
@.planning/phases/06-buy-sell-mechanic/06-RESEARCH.md
@.planning/phases/06-buy-sell-mechanic/06-01-SUMMARY.md
@game.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Buyer card rendering, offer generation, swipe direction, and Act 2 gameplay loop</name>
  <files>game.js</files>
  <action>
Implement the complete Act 2 gameplay. This builds on the 5-state machine and inventory from Plan 01.

**A. Buyer card rendering -- `drawBuyerCardToCanvas(offCtx, ox, oy, card)`:**
- Blue/teal card body with gradient: top `#e8f4f8`, bottom `#d0eef6`. Same roundRect, shadow pattern as `drawCardToCanvas` but different colors.
- Border: `#90cad8`, 1px.
- "OFFRE" label at top (~12% height), bold 10px, color `#007782`.
- Brand name centered at ~45% height, bold 12-16px (scale with card width like existing), color `#333333`.
- Offer price at ~70% height, bold 18px. Color: green `#2a7d4f` if `isGoodDeal`, red `#cc3333` if not. Show as `offerPrice + ' EUR'`.
- Directional hints at bottom (~92% height), 9px, color `rgba(0,0,0,0.3)`: left-aligned "< non", right-aligned "oui >".
- Use Unicode arrows if they render well, otherwise plain text.

**B. Buyer card sprite caching -- `createBuyerSprite(card)`:**
- Same pattern as `createCardSprite` but calls `drawBuyerCardToCanvas`. Stores on `card.sprite` and `card.spritePadding`.
- Buyer cards use the same `CARD_WIDTH` and `CARD_HEIGHT` dimensions.

**C. Offer generation -- `createBuyerOffer(inventoryItem, t)`:**
- `t` = normalized Act 2 time (0 to 1) for difficulty ramp.
- For real watches: margin ranges from generous (50-120% markup early) to tight (5-30% late). Bad offer rate: 15% early -> 50% late. Bad offers: -10% to -50% below cost.
- For fake watches: offers are always low, 5-15 EUR regardless of time. Fakes in inventory are always sellable but at a loss.
- For golden watches: offers range 150-400 EUR (premium).
- `isGoodDeal` flag: true if `offerPrice > inventoryItem.cost`.
- Return an object with all physics properties (like `spawnWatch`) PLUS `targetIndex`, `brand`, `offerPrice`, `isFake`, `isGolden`, `isGoodDeal`, `isBuyerOffer: true`.
- The card spawns from bottom like Act 1 cards, using the same `spawnWatch`-style physics (random left/right, parabolic arc). Reuse the velocity/gravity calculations from `spawnWatch`.

**D. Offer-to-inventory mapping:**
- Track `currentOfferIndex` (round-robin through unsold inventory items).
- When spawning an offer, find the next unsold item: iterate from `currentOfferIndex`, wrapping around, to find an item where `sold === false` and not currently "offered" (add `offerPending` boolean to inventory items).
- When an offer card is accepted, rejected, or falls off screen, set `offerPending = false` on the inventory item so it can get future offers.
- If ALL unsold items have `offerPending === true`, skip spawning (wait for current offers to resolve).

**E. Swipe direction detection -- `getSwipeDirection(trailPoints)`:**
- Requires at least 3 trail points.
- Calculate horizontal displacement (dx) from first to last point.
- Minimum 30px horizontal displacement.
- Horizontal component must be > 0.8x vertical component (to filter out vertical swipes).
- Return `'right'` (accept) or `'left'` (reject) or `null` (ambiguous).

**F. Act 2 collision detection -- `checkAct2Collisions()`:**
- Same structure as `checkSlashCollisions()` but calls `getSwipeDirection()` first.
- If direction is `null`, return (no clear directional swipe).
- For each card hit: if `direction === 'right'`, call `acceptOffer(card)`. If `'left'`, call `rejectOffer(card)`.

**G. `acceptOffer(offerCard)` function:**
- Mark `offerCard.slashed = true`.
- Look up `inventory[offerCard.targetIndex]`, set `sold = true`, `soldFor = offerCard.offerPrice`, `offerPending = false`.
- Add `offerCard.offerPrice` to `act2Revenue`.
- Calculate profit: `offerCard.offerPrice - inventory[offerCard.targetIndex].cost`.
- If profit >= 0: green floating text `'+X EUR'`, `SoundEngine.playCoin(0)`, green particles. If golden: `SoundEngine.playJackpot()`.
- If profit < 0: red floating text, `SoundEngine.playPenalty()`, red particles, label "Mauvaise affaire !".
- Create split halves (reuse `createSplitHalves`), spawn particles.
- Remove from watches array.

**H. `rejectOffer(offerCard)` function:**
- Mark card as slashed (to prevent re-detection).
- Set `inventory[offerCard.targetIndex].offerPending = false`.
- Fling card leftward: `offerCard.vx = -400`, `offerCard.vy = -150`.
- Show "Refuse" label text (white, 14px).
- Do NOT remove from watches array immediately (let it fly off and get cleaned up by `updateWatches`).
- Play no sound for rejects (silence = neutral action).

**I. `updateAct2(dt)` function:**
- Call `updateTrail()`.
- Increment `act2Elapsed += dt`.
- Check end conditions: (a) `act2Elapsed >= ACT2_DURATION` or (b) all inventory items are sold. If either, call `endGame()`.
- Spawn buyer offers using difficulty-ramped interval. Use similar spawn timer logic as Act 1 but with `ACT2_DURATION` for difficulty `t`. Spawn interval: 1.5s early -> 0.8s late.
- Call `checkAct2Collisions()`.
- Call `updateWatches(dt)` -- existing physics works for buyer cards too.
- Call `updateSplitHalves(dt)`, `updateParticles(dt)`, `updateFloatingTexts(dt)`.
- When a buyer offer card falls off screen (cleaned up by `updateWatches`), reset `inventory[targetIndex].offerPending = false`. Modify `updateWatches` to check `isBuyerOffer` flag and reset offerPending instead of applying miss penalty.

**J. `renderAct2(dt)` function:**
- Same structure as `renderAct1` but with Act 2 HUD:
- "Acte 2 : La Revente" header (same style as Act 1 header).
- Show `act2Revenue + ' EUR'` as revenue in the score pill area.
- Show unsold count: `N montre(s) a vendre`.
- Timer uses `ACT2_DURATION - act2Elapsed`.
- Render buyer cards using same `drawCard()`/`drawWatch()` function (they use the cached sprite).

**K. Trail color in Act 2:**
- When `gameState === 'act2'`, dynamically determine trail color based on swipe direction. In `renderTrail()`, if `gameState === 'act2'` and `trailPoints.length >= 3`, call `getSwipeDirection(trailPoints)`. If `'right'`, use `'100, 220, 100'` (green). If `'left'`, use `'220, 100, 100'` (red). Otherwise use default gold.
- For `gameState !== 'act2'`, always use the default `TRAIL_COLOR`.

**L. `endGame()` function:**
- Calculate final breakdown from inventory array (single source of truth):
  - `act1Spending` (already tracked)
  - `act2Revenue` (already tracked)
  - `unsoldLoss = sum of cost for unsold items`
  - `finalProfit = act2Revenue - act1Spending - unsoldLoss`
- Set `score = finalProfit` (for rating calculation and best score).
- `isNewBest = saveBestScore(score)`.
- Set `gameState = 'over'`.

Avoid modifying Act 1 logic (already working from Plan 01). All new Act 2 functions should be clearly separated from Act 1 functions.
  </action>
  <verify>
Open index.html. Play through Act 1 (slash 5+ cards). Tap through transition. Act 2 should show buyer offer cards flying in with blue/teal styling. Swipe RIGHT on a card to accept -- should split with coin sound, revenue shown. Swipe LEFT to reject -- card flings left with "Refuse" label. Trail should be green for right swipes, red for left swipes. Offers should reference brands from inventory. Timer counts down from 45s. When timer ends or all sold, game over screen appears. Check console for zero errors.
  </verify>
  <done>Act 2 gameplay fully functional: buyer offer cards spawn with correct styling, swipe direction accept/reject works, offers map to inventory items via round-robin, difficulty ramps via shrinking margins, trail color hints work, Act 2 ends on timer or all-sold.</done>
</task>

<task type="auto">
  <name>Task 2: Redesign game over screen for two-act scoring breakdown</name>
  <files>game.js</files>
  <action>
Redesign `renderGameOver()` to show the full two-act breakdown and update the Vinted seller rating to reflect combined performance.

1. **Replace existing `renderGameOver()`** with a two-act breakdown version:
   - Header: "Temps ecoule !" (or "Tout vendu !" if all inventory was sold before timer ended -- add a flag `allSoldEarly` set in `endGame()`).
   - **Act 1 section** (~16% height):
     - "Acte 1 - Depenses : -X EUR" in light red (#ff9999)
     - "Montres achetees : N (dont M contrefacons)" in white
   - **Act 2 section** (~24% height):
     - "Acte 2 - Recettes : +X EUR" in light green (#99ff99)
     - "Montres vendues : N / M" in white
   - **Unsold section** (~32% height):
     - Count and sum unsold items from inventory
     - "Invendus (N) : -X EUR" in red (#ff6666)
   - **Final profit** (~40% height):
     - "Profit final : +/-X EUR" in bold 22px, green if positive, red if negative
   - **Best score** below profit if exists, "Nouveau record !" if new best
   - **Vinted seller rating** at ~52% height (same stars pattern but based on finalProfit)
   - **Birthday message** at ~64% height (keep existing message exactly as-is: "Joyeux anniversaire mon frere, longue vie aux montres et a Montignac" with star decorations)
   - **Replay button** at ~85% height (same as existing)

2. **Update `getRating(s)` thresholds** for two-act economy:
   - The score ranges need recalibration since the economy is different. With Act 1 spending (~50-150 EUR typical) and Act 2 revenue, thresholds should be:
     - 5 stars: >= 100 EUR profit ("Roi du Vinted")
     - 4 stars: >= 40 EUR ("Vendeur confirme")
     - 3 stars: >= 0 EUR ("Bon vendeur")
     - 2 stars: >= -50 EUR ("Vendeur debutant")
     - 1 star: < -50 EUR ("Vendeur douteux")
   - These are estimates; the user may tune later.

3. **Handle "all sold early" case:**
   - In `endGame()`, check if all inventory items are sold. If so, set `allSoldEarly = true` (new flag, add to top-level vars and reset in `resetGame`).
   - On game over screen, show "Tout vendu ! Bravo !" header instead of "Temps ecoule !".

4. **Ensure replay works:** Tapping "Rejouer" calls `startGame()` which calls `resetGame()` (already clears inventory and act variables from Plan 01), then sets `gameState = 'act1'`.

5. **Layout carefully** to fit mobile screen. Use smaller fonts if needed (14-16px for breakdown lines, 22px for profit, 18px for message). Test that nothing overlaps on a ~375x667 viewport.
  </action>
  <verify>
Play a full game (Act 1 -> Transition -> Act 2 -> Game Over). Game over screen should show: Act 1 spending, Act 2 revenue, unsold losses, final profit, best score (if applicable), Vinted rating with stars, birthday message, and replay button. Tap "Rejouer" -- full game restarts cleanly from Act 1. Play again to verify no state leaks between games. Check console for zero errors.
  </verify>
  <done>Game over screen shows complete two-act breakdown with Act 1 spending, Act 2 revenue, unsold losses, final profit, rating, birthday message, and replay. Best scores persist. Replay restarts cleanly.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Full two-act gameplay verification on mobile</name>
  <what-built>Complete two-act Buy/Sell mechanic: Act 1 buying phase with inventory tracking, transition screen with fake reveal, Act 2 selling phase with directional swipe accept/reject, and game over screen with full scoring breakdown.</what-built>
  <how-to-verify>
1. Open https://coupe-des-montres.jimmydore.fr on mobile Chrome (or localhost if not deployed yet)
2. Tap "Jouer" -- verify "Acte 1 : Les Achats" header and inventory counter visible
3. Slash several cards (mix of real, fake). Verify inventory counter increments
4. Let timer run out -- transition screen appears
5. Check: inventory list shows correct brands, fakes highlighted in red, fake reveal message
6. Tap "Vendre !" -- Act 2 starts
7. Verify buyer cards have blue/teal styling with "OFFRE" label, brand name, price, and arrow hints
8. Swipe RIGHT on a card -- should accept with split animation and sound
9. Swipe LEFT on a card -- should reject with "Refuse" label and card flung left
10. Verify trail turns green on right swipes, red on left swipes
11. Let Act 2 end (timer or sell everything) -- game over screen appears
12. Check breakdown: Act 1 spending, Act 2 revenue, unsold losses, final profit
13. Verify birthday message and Vinted rating stars are visible
14. Tap "Rejouer" and play again -- verify clean restart with no state leaks
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues to fix</resume-signal>
</task>

</tasks>

<verification>
Full game flow test:
1. Start -> Act 1 (buy cards) -> Transition (inventory + fake reveal) -> Act 2 (sell with swipe) -> Game Over (breakdown)
2. Empty inventory edge case: don't slash anything in Act 1 -> transition shows empty message -> game over
3. All sold early: sell all inventory before timer -> "Tout vendu !" game over
4. Replay: game restarts cleanly with no state leaks
5. All existing features work: trail, particles, combos, sound, haptics, decorative watches on start screen
</verification>

<success_criteria>
- Act 2 buyer cards render with distinct blue/teal styling
- Swipe RIGHT accepts offers, swipe LEFT rejects -- both feel responsive on mobile
- Offers map to actual inventory items (no phantom offers for unbought watches)
- Difficulty ramps via shrinking margins, not speed
- Game over shows accurate breakdown (numbers add up)
- Replay loop works without state contamination
- All MECH-01 through MECH-08 requirements satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/06-buy-sell-mechanic/06-02-SUMMARY.md`
</output>
