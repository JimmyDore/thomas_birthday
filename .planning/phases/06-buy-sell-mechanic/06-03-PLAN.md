---
phase: 06-buy-sell-mechanic
plan: 03
type: execute
wave: 3
depends_on: ["06-02"]
files_modified: [game.js]
autonomous: false

must_haves:
  truths:
    - "Act 2 buyer cards fly in and can be swiped to accept/reject during a 45s timer"
    - "Act 2 ends when timer runs out OR all inventory is sold"
    - "Trail color changes to green (right swipe) or red (left swipe) during Act 2"
    - "Game over screen shows full breakdown: Act 1 spending, Act 2 revenue, unsold losses, final profit"
    - "Vinted seller rating reflects combined two-act performance"
    - "Replay restarts cleanly from Act 1 with no state leaks"
  artifacts:
    - path: "game.js"
      provides: "Act 2 game loop, game over redesign, trail color, endGame"
      contains: "updateAct2"
  key_links:
    - from: "updateAct2"
      to: "createBuyerOffer + checkAct2Collisions"
      via: "Act 2 loop spawns offers and checks collisions each frame"
      pattern: "updateAct2"
    - from: "endGame"
      to: "act2Revenue - act1Spending - unsoldLoss"
      via: "final profit calculated from inventory array"
      pattern: "act2Revenue.*act1Spending"
    - from: "renderGameOver"
      to: "inventory breakdown"
      via: "game over screen reads inventory for sold/unsold counts and sums"
      pattern: "renderGameOver"
---

<objective>
Wire all Act 2 primitives from Plan 02 into the game loop, add trail color hints, redesign the game over screen for two-act scoring, and verify the complete two-act flow on mobile.

Purpose: This plan completes the gameplay loop. Plan 02 built the building blocks (rendering, offers, swipe, accept/reject). This plan orchestrates them into a playable Act 2 and delivers the final scoring experience.

Output: Fully playable two-act game with Act 2 game loop, trail color hints, complete game over screen, and human-verified mobile experience.
</objective>

<execution_context>
@/Users/jimmydore/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jimmydore/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-buy-sell-mechanic/06-CONTEXT.md
@.planning/phases/06-buy-sell-mechanic/06-RESEARCH.md
@.planning/phases/06-buy-sell-mechanic/06-01-SUMMARY.md
@.planning/phases/06-buy-sell-mechanic/06-02-SUMMARY.md
@game.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Act 2 game loop, trail color hints, and endGame</name>
  <files>game.js</files>
  <action>
Wire the Act 2 primitives (from Plan 02) into the game loop and add trail color feedback.

**I. `updateAct2(dt)` function:**
- Call `updateTrail()`.
- Increment `act2Elapsed += dt`.
- Check end conditions: (a) `act2Elapsed >= ACT2_DURATION` or (b) all inventory items are sold (`inventory.every(function(item) { return item.sold; })`). If either, call `endGame()` and return.
- Spawn buyer offers using difficulty-ramped interval. Compute `t = act2Elapsed / ACT2_DURATION`. Spawn interval: lerp from 1.5s (t=0) to 0.8s (t=1). Use a spawn timer variable (`act2SpawnTimer`), same pattern as Act 1's `spawnTimer`. Call `findNextUnsoldItem()` to get target index. If -1 (all pending), skip spawn. Otherwise call `createBuyerOffer(inventory[idx], idx, t)` and push to `watches` array.
- Call `checkAct2Collisions()`.
- Call `updateWatches(dt)` -- existing physics works for buyer cards too. Modify `updateWatches` to check `isBuyerOffer` flag: when a buyer offer card falls off screen (cleaned up), reset `inventory[card.targetIndex].offerPending = false` instead of applying miss penalty.
- Call `updateSplitHalves(dt)`, `updateParticles(dt)`, `updateFloatingTexts(dt)`.
- Add `act2SpawnTimer` to top-level vars (near other Act 2 vars). Reset it in `resetGame()`.

**J. `renderAct2(dt)` function:**
- Same structure as `renderAct1` but with Act 2 HUD:
- Call `renderBackground()`.
- Render all watches (buyer cards use their cached buyer sprites via existing `drawCard()`).
- Render split halves, particles, floating texts, trail (same calls as renderAct1).
- "Acte 2 : La Revente" header (same style as Act 1 header, centered, 14px bold, white with slight transparency).
- Show revenue display: modify `renderScore()` or add inline rendering to show `'Recettes: ' + act2Revenue + ' EUR'` in white at the score position.
- Show unsold count: `N montre(s) a vendre` below inventory counter position. Count unsold items from inventory.
- Timer: render using `ACT2_DURATION - act2Elapsed` (same timer rendering as Act 1).

**K. Trail color in Act 2 (folded into renderTrail modification):**
- In `renderTrail()`, add a check: if `gameState === 'act2'` and `trailPoints.length >= 3`, call `getSwipeDirection(trailPoints)`. If `'right'`, use trail RGB `'100, 220, 100'` (green). If `'left'`, use `'220, 100, 100'` (red). Otherwise use default `TRAIL_COLOR`.
- For `gameState !== 'act2'`, always use the default `TRAIL_COLOR`. This is a small inline modification -- 5-6 lines inside renderTrail.

**L. `endGame()` function:**
- Calculate final breakdown from inventory array (single source of truth):
  - `act1Spending` (already tracked)
  - `act2Revenue` (already tracked)
  - `unsoldLoss = 0; inventory.forEach(function(item) { if (!item.sold) unsoldLoss += item.cost; });`
  - `finalProfit = act2Revenue - act1Spending`
- Set `score = finalProfit` (for rating calculation and best score).
- `isNewBest = saveBestScore(score)`.
- Check if all inventory sold: set `allSoldEarly = true` if so (new flag, add to top-level vars, reset in `resetGame()`).
- Set `gameState = 'over'`.

**Wire into gameLoop:** Replace the Act 2 stub (`'act2'` branch in `gameLoop`) with calls to `updateAct2(dt)` and `renderAct2(dt)`.
  </action>
  <verify>
Open index.html. Play through Act 1 (slash 5+ cards). Tap through transition. Act 2 should show buyer offer cards flying in with blue/teal styling. Swipe RIGHT on a card to accept -- should split with sound, revenue shown. Swipe LEFT to reject -- card flings left with "Refuse". Trail should turn green for right swipes, red for left swipes. Timer counts down from 45s. When timer ends or all sold, game goes to game over state (may show old/broken game over screen -- that is fine, Task 2 fixes it). Check console for zero errors.
  </verify>
  <done>Act 2 gameplay loop runs: buyer offers spawn with difficulty ramp, swipe direction controls accept/reject, trail color provides directional feedback, Act 2 ends on timer or all-sold, endGame calculates final profit and saves best score.</done>
</task>

<task type="auto">
  <name>Task 2: Redesign game over screen for two-act scoring breakdown</name>
  <files>game.js</files>
  <action>
Redesign `renderGameOver()` to show the full two-act breakdown and update the Vinted seller rating to reflect combined performance.

1. **Replace existing `renderGameOver()`** with a two-act breakdown version:
   - Header: "Temps ecoule !" (or "Tout vendu !" if `allSoldEarly` is true).
   - **Act 1 section** (~16% height):
     - "Acte 1 - Depenses : -X EUR" in light red (#ff9999)
     - "Montres achetees : N (dont M contrefacons)" in white, 14px
   - **Act 2 section** (~24% height):
     - "Acte 2 - Recettes : +X EUR" in light green (#99ff99)
     - "Montres vendues : N / M" in white, 14px
   - **Unsold section** (~32% height):
     - Count and sum unsold items from inventory
     - "Invendus (N) : -X EUR" in red (#ff6666)
   - **Final profit** (~40% height):
     - "Profit final : +/-X EUR" in bold 22px, green (#50e880) if positive, red (#ff6666) if negative
   - **Best score** below profit if exists, "Nouveau record !" if new best
   - **Vinted seller rating** at ~52% height (same stars pattern but based on finalProfit)
   - **Birthday message** at ~64% height (keep existing message exactly as-is: "Joyeux anniversaire mon frere, longue vie aux montres et a Montignac" with star decorations)
   - **Replay button** at ~85% height (same as existing replayButton)

2. **Update `getRating(s)` thresholds** for two-act economy:
   - 5 stars: >= 100 EUR profit ("Roi du Vinted")
   - 4 stars: >= 40 EUR ("Vendeur confirme")
   - 3 stars: >= 0 EUR ("Bon vendeur")
   - 2 stars: >= -50 EUR ("Vendeur debutant")
   - 1 star: < -50 EUR ("Vendeur douteux")

3. **Handle "all sold early" case:**
   - In game over header, show "Tout vendu ! Bravo !" if `allSoldEarly` flag is set.

4. **Ensure replay works:** Tapping "Rejouer" calls `startGame()` which calls `resetGame()` (clears inventory, act variables, allSoldEarly), then sets `gameState = 'act1'`.

5. **Layout carefully** to fit mobile screen (~375x667 viewport). Use smaller fonts if needed (14-16px for breakdown lines, 22px for profit, 18px for message). Ensure nothing overlaps.
  </action>
  <verify>
Play a full game (Act 1 -> Transition -> Act 2 -> Game Over). Game over screen should show: Act 1 spending, Act 2 revenue, unsold losses, final profit, best score (if applicable), Vinted rating with stars, birthday message, and replay button. Tap "Rejouer" -- full game restarts cleanly from Act 1. Play again to verify no state leaks between games. Check console for zero errors.
  </verify>
  <done>Game over screen shows complete two-act breakdown with Act 1 spending, Act 2 revenue, unsold losses, final profit, rating, birthday message, and replay. Best scores persist. Replay restarts cleanly.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Full two-act gameplay verification on mobile</name>
  <what-built>Complete two-act Buy/Sell mechanic: Act 1 buying phase with inventory tracking, transition screen with fake reveal, Act 2 selling phase with directional swipe accept/reject and trail color hints, and game over screen with full scoring breakdown.</what-built>
  <how-to-verify>
1. Open https://coupe-des-montres.jimmydore.fr on mobile Chrome (or localhost if not deployed yet)
2. Tap "Jouer" -- verify "Acte 1 : Les Achats" header and inventory counter visible
3. Slash several cards (mix of real, fake). Verify inventory counter increments
4. Let timer run out -- transition screen appears
5. Check: inventory list shows correct brands, fakes highlighted in red, fake reveal message
6. Tap "Vendre !" -- Act 2 starts
7. Verify buyer cards have blue/teal styling with "OFFRE" label, brand name, price, and arrow hints
8. Swipe RIGHT on a card -- should accept with split animation and sound
9. Swipe LEFT on a card -- should reject with "Refuse" label and card flung left
10. Verify trail turns green on right swipes, red on left swipes
11. Let Act 2 end (timer or sell everything) -- game over screen appears
12. Check breakdown: Act 1 spending, Act 2 revenue, unsold losses, final profit
13. Verify birthday message and Vinted rating stars are visible
14. Tap "Rejouer" and play again -- verify clean restart with no state leaks
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues to fix</resume-signal>
</task>

</tasks>

<verification>
Full game flow test:
1. Start -> Act 1 (buy cards) -> Transition (inventory + fake reveal) -> Act 2 (sell with swipe) -> Game Over (breakdown)
2. Empty inventory edge case: don't slash anything in Act 1 -> transition shows empty message -> game over
3. All sold early: sell all inventory before timer -> "Tout vendu !" game over
4. Replay: game restarts cleanly with no state leaks
5. All existing features work: trail, particles, combos, sound, haptics, decorative watches on start screen
</verification>

<success_criteria>
- Act 2 buyer cards spawn with difficulty-ramped intervals and proper offer mapping
- Trail color dynamically changes based on swipe direction in Act 2
- Game over shows accurate two-act breakdown (numbers add up)
- Replay loop works without state contamination
- All MECH-01 through MECH-08 requirements satisfied
- Full game verified on mobile by user
</success_criteria>

<output>
After completion, create `.planning/phases/06-buy-sell-mechanic/06-03-SUMMARY.md`
</output>
