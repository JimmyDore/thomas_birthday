---
phase: 05-sound-effects
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [game.js]
autonomous: false

must_haves:
  truths:
    - "Swiping produces an audible swoosh on every swipe, hitting a card adds a distinct impact thud"
    - "Slashing a real card plays a coin cha-ching, slashing a fake plays a penalty buzz -- distinguishable by sound alone"
    - "Golden jackpot cards play a special celebratory ascending arpeggio distinct from regular coin sounds"
    - "All sounds work on mobile Chrome on first play with no silent first round"
  artifacts:
    - path: "game.js"
      provides: "SoundEngine object with init, unlock, playSwipe, playImpact, playCoin, playPenalty, playJackpot"
      contains: "var SoundEngine"
  key_links:
    - from: "handleStartTap()"
      to: "SoundEngine.unlock()"
      via: "call before startGame()"
      pattern: "SoundEngine\\.unlock\\(\\)"
    - from: "handleReplayTap()"
      to: "SoundEngine.unlock()"
      via: "call before startGame()"
      pattern: "SoundEngine\\.unlock\\(\\)"
    - from: "pointerdown handler"
      to: "SoundEngine.playSwipe()"
      via: "call after isPointerDown = true"
      pattern: "SoundEngine\\.playSwipe\\(\\)"
    - from: "slashWatch()"
      to: "SoundEngine.playImpact/playCoin/playPenalty/playJackpot"
      via: "conditional calls matching isFake/isGolden branching"
      pattern: "SoundEngine\\.play(Impact|Coin|Penalty|Jackpot)"
---

<objective>
Add procedural audio feedback to every game interaction using Web Audio API with zero audio files. A SoundEngine object provides swoosh, impact, coin, penalty, and jackpot sounds. All sounds synthesized in real-time, unlocked on first user tap, and working on mobile Chrome from first play.

Purpose: Make the game feel alive -- every swipe, hit, and score change has satisfying audio feedback that reinforces whether the player did something good or bad.
Output: game.js with integrated SoundEngine producing 5 distinct procedural sounds at correct game events.
</objective>

<execution_context>
@/Users/jimmydore/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jimmydore/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-sound-effects/05-RESEARCH.md
@game.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SoundEngine and wire into game events</name>
  <files>game.js</files>
  <action>
Add a SoundEngine object near the top of game.js (after the high score section, before the watch/card code). The SoundEngine owns one AudioContext and one pre-generated white noise AudioBuffer, and exposes fire-and-forget sound functions.

**SoundEngine structure:**

```javascript
var SoundEngine = (function() {
  var audioCtx = null;
  var noiseBuffer = null;

  function init() { ... }      // Create AudioContext + noise buffer
  function unlock() { ... }    // Resume if suspended
  function playSwipe() { ... } // SFX-01
  function playImpact(isGolden) { ... } // SFX-02
  function playCoin(comboCount) { ... } // SFX-03
  function playPenalty() { ... } // SFX-04
  function playJackpot() { ... } // SFX-05

  return { init, unlock, playSwipe, playImpact, playCoin, playPenalty, playJackpot };
})();
```

**Sound implementations (from RESEARCH.md, use these exact recipes):**

1. **init():** Create `AudioContext({ latencyHint: 'interactive' })` with webkit fallback. Pre-generate a 2-second white noise AudioBuffer (fill with `Math.random() * 2 - 1`).

2. **unlock():** If `audioCtx && audioCtx.state === 'suspended'`, call `audioCtx.resume()`.

3. **playSwipe() [SFX-01]:** Filtered white noise burst, 120ms. Bandpass filter sweeping 2500Hz->1000Hz, gain 0.15->0.001 exponential ramp. Guard: return early if `!audioCtx || audioCtx.state !== 'running'`.

4. **playImpact(isGolden) [SFX-02]:** Two layers -- (a) sine oscillator thud sweeping from 150Hz (or 200Hz if golden) down to 40Hz over 150ms, gain 0.4->0.001; (b) noise transient crack via highpass 4000Hz, 40ms, gain 0.2->0.001.

5. **playCoin(comboCount) [SFX-03]:** Two-tone square wave arpeggio. Base freq 800Hz, pitch escalated by `Math.pow(2, Math.min(comboCount || 0, 12) * 2 / 12)`. First tone at freq for 120ms, second tone at freq*1.5 starting 70ms later for 200ms total. Gain 0.15, square waveform.

6. **playPenalty() [SFX-04]:** Two detuned sawtooth oscillators (120Hz + 127Hz), lowpass filter at 600Hz, 250ms duration. Gain 0.12 with quick 20ms attack to 0.15 then exponential decay.

7. **playJackpot() [SFX-05]:** Triangle wave arpeggio C5-E5-G5-C6 (523, 659, 784, 1047 Hz). Each note starts 80ms after previous, duration ~250ms each. Gain ramps to 0.2 per note.

**Critical rules (from RESEARCH.md pitfalls):**
- Always call `setValueAtTime()` BEFORE any ramp method
- Use 0.001 as floor for `exponentialRampToValueAtTime` (cannot target 0)
- Create fresh nodes per sound (single-use by spec)
- Keep nodes connected to destination until stop() (prevents premature GC)

**Integration points -- add these calls to existing functions:**

1. **After the IIFE definition:** Call `SoundEngine.init()` immediately (outside any function, at module level).

2. **handleStartTap() (line ~1001):** Add `SoundEngine.unlock();` BEFORE the `startGame()` call, inside the button hit test if-block.

3. **handleReplayTap() (line ~1125):** Add `SoundEngine.unlock();` BEFORE the `startGame()` call, inside the button hit test if-block.

4. **pointerdown handler (line ~165):** Add `SoundEngine.playSwipe();` AFTER `isPointerDown = true;` in the `gameState === 'playing'` block.

5. **slashWatch() (line ~415):** Add sound calls AFTER the existing haptic feedback call (line ~463) and BEFORE the watch removal. Use the existing isFake/isGolden branching:
   - Always call `SoundEngine.playImpact(watch.isGolden);`
   - If `watch.isGolden`: call `SoundEngine.playJackpot();`
   - Else if `watch.isFake`: call `SoundEngine.playPenalty();`
   - Else (real, not golden): call `SoundEngine.playCoin(combo);`
   Note: `combo` is already updated by this point in slashWatch, so playCoin gets the current combo count.
  </action>
  <verify>
1. Open game.js and confirm SoundEngine IIFE exists with all 7 methods (init, unlock, playSwipe, playImpact, playCoin, playPenalty, playJackpot)
2. Confirm SoundEngine.init() is called at module level
3. Confirm SoundEngine.unlock() appears in both handleStartTap and handleReplayTap
4. Confirm SoundEngine.playSwipe() appears in the pointerdown handler
5. Confirm slashWatch() calls playImpact + conditional playCoin/playPenalty/playJackpot
6. Open index.html in browser, open DevTools console -- no errors on page load
7. Click "Jouer", swipe -- confirm no console errors (sound may not play without interaction on some browsers, that is fine for desktop testing)
  </verify>
  <done>
SoundEngine object exists in game.js with all 5 sound functions + init + unlock. All 6 integration points are wired: init at module level, unlock in both tap handlers, playSwipe in pointerdown, and impact+feedback sounds in slashWatch with correct conditional branching.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify sounds on mobile Chrome</name>
  <what-built>Complete procedural audio system: swoosh on swipe, impact thud on card hit, coin cha-ching on real cards (pitch rising with combo), penalty buzz on fakes, jackpot fanfare on golden cards. All synthesized via Web Audio API with no audio files.</what-built>
  <how-to-verify>
1. Open the game on mobile Chrome (or push to production first if needed)
2. Tap "Jouer" -- this should unlock audio (no separate audio prompt)
3. Swipe anywhere -- you should hear a short swoosh sound on every swipe
4. Slash a real card -- you should hear swoosh + thud impact + coin cha-ching
5. Slash several real cards in a row -- coin sound should rise in pitch with combo
6. Slash a fake card -- you should hear swoosh + thud + harsh buzzer (clearly different from coin)
7. Slash a golden card -- you should hear swoosh + thud + ascending celebratory fanfare
8. Tap "Rejouer" and play again -- sounds should work immediately (no silent second round)
9. Overall: sounds should feel snappy and satisfying, not too loud, not annoying after repeated play
  </how-to-verify>
  <resume-signal>Type "approved" if sounds work and feel good, or describe any issues (too loud, wrong timing, missing sounds, etc.)</resume-signal>
</task>

</tasks>

<verification>
- No console errors on page load or during gameplay
- AudioContext state is 'running' after tapping "Jouer" (check via console: type `SoundEngine` to inspect)
- Each of the 5 sound types is audibly distinct
- Combo pitch escalation is noticeable across consecutive real card hits
- Sounds are short enough to not overlap annoyingly during fast slashing
- No clicks/pops at sound start or end
- Game performance is unaffected (no frame drops from audio)
</verification>

<success_criteria>
- SFX-01: Swoosh plays on every swipe (pointerdown during gameplay)
- SFX-02: Impact thud plays on every card slash
- SFX-03: Coin cha-ching plays on real card slash with combo pitch escalation
- SFX-04: Penalty buzz plays on fake card slash, clearly distinguishable from coin
- SFX-05: Jackpot fanfare plays on golden card slash, distinct from regular coin
- SFX-06: All sounds generated via Web Audio API procedural synthesis, zero audio files
- Mobile Chrome works on first play -- no silent first round, no tap-to-enable-audio prompt
</success_criteria>

<output>
After completion, create `.planning/phases/05-sound-effects/05-01-SUMMARY.md`
</output>
