---
phase: 03-ship-it
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - index.html
  - .github/workflows/deploy.yml
autonomous: true

must_haves:
  truths:
    - "index.html has Open Graph meta tags for WhatsApp/iMessage link previews"
    - "index.html has an emoji favicon and a proper page title"
    - "A GitHub Actions workflow exists that deploys on push to master via SSH"
    - "Code is pushed to a GitHub repo with deploy secrets configured"
  artifacts:
    - path: "index.html"
      provides: "OG meta tags, favicon, title"
      contains: "og:title"
    - path: ".github/workflows/deploy.yml"
      provides: "CI/CD deploy pipeline"
      contains: "appleboy/ssh-action"
  key_links:
    - from: ".github/workflows/deploy.yml"
      to: "VPS at coupe-des-montres.jimmydore.fr"
      via: "SSH with secrets.VPS_HOST, VPS_USER, VPS_SSH_KEY"
      pattern: "secrets\\.VPS_"
---

<objective>
Prepare all local deployment assets and set up the GitHub repository with CI/CD.

Purpose: Get everything ready on the local/GitHub side so the VPS just needs to be configured to receive deploys.
Output: index.html with OG tags + favicon, GitHub Actions workflow, GitHub repo with secrets configured.
</objective>

<execution_context>
@/Users/jimmydore/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jimmydore/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-ship-it/03-CONTEXT.md
@.planning/phases/03-ship-it/03-RESEARCH.md
@index.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add OG meta tags, favicon, and title to index.html</name>
  <files>index.html</files>
  <action>
    Edit index.html to add inside the `<head>` section, BEFORE the existing `<style>` block:

    1. A `<title>` tag: `La Coupe des Montres`

    2. Open Graph meta tags for WhatsApp/iMessage link previews:
       - `og:title` = "La Coupe des Montres"
       - `og:description` = Something funny and fitting for Thomas's birthday gift. Example: "Joyeux anniversaire Thomas ! Tranche les montres... mais gare aux contrefacons." (Claude's discretion on exact wording -- keep it short, funny, in French, and hint at the Fruit Ninja parody.)
       - `og:type` = "website"
       - `og:url` = "https://coupe-des-montres.jimmydore.fr"
       - `og:image` = "https://coupe-des-montres.jimmydore.fr/og-image.png" (image file will be added later)
       - `og:image:width` = "1200"
       - `og:image:height` = "630"

    3. Inline emoji favicon using SVG data URI (no file needed):
       `<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>&#x2694;</text></svg>">`
       This renders a crossed swords emoji as the favicon. Works in Chrome (our target).

    Keep all existing content (charset, viewport, style, body) unchanged. Only ADD new tags in the head.
  </action>
  <verify>Read index.html and confirm: title tag present, all 7 og: meta tags present, favicon link tag present, existing viewport/style/body unchanged.</verify>
  <done>index.html has title "La Coupe des Montres", 7 OG meta tags with absolute URLs, and an inline emoji favicon.</done>
</task>

<task type="auto">
  <name>Task 2: Create GitHub Actions deploy workflow</name>
  <files>.github/workflows/deploy.yml</files>
  <action>
    Create `.github/workflows/deploy.yml` with this exact content:

    ```yaml
    name: Deploy

    on:
      push:
        branches: [master]

    jobs:
      deploy:
        runs-on: ubuntu-latest
        steps:
          - name: Deploy via SSH
            uses: appleboy/ssh-action@v1
            with:
              host: ${{ secrets.VPS_HOST }}
              username: ${{ secrets.VPS_USER }}
              key: ${{ secrets.VPS_SSH_KEY }}
              script: |
                cd /var/www/coupe-des-montres.jimmydore.fr
                git pull origin master
    ```

    This workflow:
    - Triggers on push to master branch
    - Uses appleboy/ssh-action@v1 (most popular SSH action, ED25519 support)
    - SSHs into the VPS and runs `git pull` in the web root
    - Requires three GitHub secrets: VPS_HOST, VPS_USER, VPS_SSH_KEY

    Create the `.github/workflows/` directory if it does not exist.
  </action>
  <verify>File exists at `.github/workflows/deploy.yml`. Content matches the YAML above. Directory structure `.github/workflows/` exists.</verify>
  <done>GitHub Actions workflow file exists and will trigger a git-pull deploy on every push to master.</done>
</task>

<task type="auto">
  <name>Task 3: Create GitHub repo, generate deploy key, set secrets, push</name>
  <files></files>
  <action>
    This task sets up the GitHub infrastructure. Execute these steps in order:

    1. **Read VPS hostname from SSH config:**
       Run: `grep -A5 'Host vpsjim' ~/.ssh/config` to find the actual hostname/IP.
       Store this value for the VPS_HOST secret.

    2. **Create GitHub repo (public):**
       Run: `gh repo create thomas_birthday --public --source=. --remote=origin --push`
       If remote `origin` already exists, skip creation and just push.
       The repo is public because it's a birthday game with nothing sensitive.

    3. **Generate ED25519 deploy SSH key (no passphrase):**
       Run: `ssh-keygen -t ed25519 -C "github-actions-deploy-coupe-des-montres" -f ~/.ssh/deploy_coupe_des_montres -N ""`
       If the key already exists, skip this step.

    4. **Add public key to VPS authorized_keys:**
       Run: `ssh vpsjim 'mkdir -p ~/.ssh && cat >> ~/.ssh/authorized_keys' < ~/.ssh/deploy_coupe_des_montres.pub`
       This allows GitHub Actions to SSH into the VPS using this key.

    5. **Set GitHub secrets:**
       Run these three commands (using the hostname found in step 1):
       - `gh secret set VPS_HOST --body "THE_HOSTNAME_FROM_STEP_1"`
       - `gh secret set VPS_USER --body "jimmydore"`
       - `gh secret set VPS_SSH_KEY < ~/.ssh/deploy_coupe_des_montres`

    6. **Push all code to GitHub:**
       Run: `git push origin master`
       Ensure all local commits (including the new workflow and OG tags) are pushed.

    IMPORTANT: If `gh` CLI is not authenticated, this will fail with an auth error. In that case, note the error and continue -- the user can authenticate later.
    IMPORTANT: Do NOT use `git push --force`. Normal push only.
  </action>
  <verify>
    - `gh repo view` shows the repo exists on GitHub
    - `gh secret list` shows VPS_HOST, VPS_USER, VPS_SSH_KEY
    - `git remote -v` shows origin pointing to GitHub
    - `~/.ssh/deploy_coupe_des_montres` and `~/.ssh/deploy_coupe_des_montres.pub` exist
  </verify>
  <done>GitHub repo exists with code pushed, deploy SSH key generated and authorized on VPS, three deploy secrets (VPS_HOST, VPS_USER, VPS_SSH_KEY) configured in GitHub.</done>
</task>

</tasks>

<verification>
- `index.html` contains `<title>`, `og:title`, `og:description`, `og:url`, `og:image`, `og:type`, `og:image:width`, `og:image:height`, and favicon link
- `.github/workflows/deploy.yml` exists with correct YAML structure
- GitHub repo accessible via `gh repo view`
- Three secrets set: `gh secret list` shows VPS_HOST, VPS_USER, VPS_SSH_KEY
- Deploy key exists locally and public key is in VPS authorized_keys
</verification>

<success_criteria>
All local deployment artifacts are prepared and the GitHub repo is configured with CI/CD secrets. The only remaining work is VPS-side setup (nginx, certbot, git clone) which requires interactive sudo access.
</success_criteria>

<output>
After completion, create `.planning/phases/03-ship-it/03-01-SUMMARY.md`
</output>
