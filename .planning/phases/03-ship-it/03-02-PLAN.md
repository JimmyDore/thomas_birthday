---
phase: 03-ship-it
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified: []
autonomous: false

user_setup:
  - service: VPS (nginx + certbot)
    why: "nginx reload and certbot require sudo with password -- cannot be automated via non-interactive SSH"
    dashboard_config:
      - task: "Create nginx config, symlink, reload nginx, run certbot on VPS"
        location: "Interactive SSH session via `ssh vpsjim`"

must_haves:
  truths:
    - "Visiting https://coupe-des-montres.jimmydore.fr on mobile Chrome loads and plays the game"
    - "Pushing to master on GitHub triggers an automated deployment that updates the live site"
    - "The site serves over HTTPS with a valid SSL certificate"
  artifacts:
    - path: "/var/www/coupe-des-montres.jimmydore.fr/index.html"
      provides: "Game served by nginx on VPS"
    - path: "/etc/nginx/sites-available/coupe-des-montres.jimmydore.fr"
      provides: "nginx server block for the domain"
  key_links:
    - from: "GitHub Actions (push to master)"
      to: "/var/www/coupe-des-montres.jimmydore.fr"
      via: "SSH + git pull"
      pattern: "git pull origin master"
    - from: "nginx"
      to: "/var/www/coupe-des-montres.jimmydore.fr"
      via: "server block root directive"
      pattern: "root /var/www/coupe-des-montres"
    - from: "certbot"
      to: "nginx config"
      via: "auto-configured SSL block"
      pattern: "ssl_certificate"
---

<objective>
Set up the VPS to serve the game and verify the full deployment pipeline works end-to-end.

Purpose: Get the game live at https://coupe-des-montres.jimmydore.fr with HTTPS and working CI/CD.
Output: Live game accessible via HTTPS, automated deploys on push to master.
</objective>

<execution_context>
@/Users/jimmydore/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jimmydore/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-ship-it/03-CONTEXT.md
@.planning/phases/03-ship-it/03-RESEARCH.md
@.planning/phases/03-ship-it/03-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Clone repo on VPS and prepare web directory</name>
  <files></files>
  <action>
    Use `ssh vpsjim` to execute commands on the VPS (non-sudo only).

    1. **Create web directory and clone repo:**
       ```
       ssh vpsjim 'mkdir -p /var/www/coupe-des-montres.jimmydore.fr'
       ssh vpsjim 'git clone https://github.com/JimmyDore/thomas_birthday.git /var/www/coupe-des-montres.jimmydore.fr'
       ```
       If /var/www/ requires elevated permissions for mkdir, try cloning to a temp dir first:
       ```
       ssh vpsjim 'git clone https://github.com/JimmyDore/thomas_birthday.git /tmp/coupe-des-montres && sudo cp -r /tmp/coupe-des-montres/. /var/www/coupe-des-montres.jimmydore.fr/ && rm -rf /tmp/coupe-des-montres'
       ```
       Note: sudo cp is allowed without password (NOPASSWD for cp).

    2. **Set file ownership (NOPASSWD sudo for chown):**
       ```
       ssh vpsjim 'sudo chown -R jimmydore:www-data /var/www/coupe-des-montres.jimmydore.fr'
       ```

    3. **Set group sticky bit so future git pulls maintain www-data group:**
       ```
       ssh vpsjim 'sudo chmod g+s /var/www/coupe-des-montres.jimmydore.fr'
       ```

    4. **Verify files are served:**
       ```
       ssh vpsjim 'ls -la /var/www/coupe-des-montres.jimmydore.fr/index.html'
       ```

    IMPORTANT: Be extra careful -- the VPS hosts other services. Only create NEW directories/files. Do NOT modify any existing files or configs.
    IMPORTANT: If any command fails, stop and report the error. Do not try to fix VPS issues autonomously.
  </action>
  <verify>
    `ssh vpsjim 'ls /var/www/coupe-des-montres.jimmydore.fr/index.html'` returns the file.
    `ssh vpsjim 'stat -c "%U:%G" /var/www/coupe-des-montres.jimmydore.fr'` shows `jimmydore:www-data`.
  </verify>
  <done>Game files are cloned to /var/www/coupe-des-montres.jimmydore.fr on the VPS, owned by jimmydore:www-data.</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 2: User sets up nginx config and SSL on VPS</name>
  <action>
    The following commands require `sudo` with a password, which cannot be done via non-interactive SSH. The user must SSH in interactively and run them.
  </action>
  <instructions>
    SSH into the VPS interactively and run these commands:

    ```bash
    ssh vpsjim
    ```

    **Step 1: Create nginx config file**
    ```bash
    sudo tee /etc/nginx/sites-available/coupe-des-montres.jimmydore.fr << 'NGINX'
    server {
        listen 80;
        server_name coupe-des-montres.jimmydore.fr;

        root /var/www/coupe-des-montres.jimmydore.fr;
        index index.html;

        location / {
            try_files $uri $uri/ =404;
        }

        # Block dotfiles (.git, .planning, .claude)
        location ~ /\. {
            deny all;
            return 404;
        }

        # Gzip for JS (game.js is ~35KB)
        gzip on;
        gzip_types text/css application/javascript text/javascript;
        gzip_min_length 256;

        # Cache static assets (7d -- no cache busting, need reasonable freshness)
        location ~* \.(css|js|jpg|jpeg|png|gif|ico|svg|woff|woff2)$ {
            expires 7d;
            add_header Cache-Control "public";
        }

        # Security headers
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
    }
    NGINX
    ```

    **Step 2: Enable the site (symlink)**
    ```bash
    sudo ln -s /etc/nginx/sites-available/coupe-des-montres.jimmydore.fr /etc/nginx/sites-enabled/
    ```

    **Step 3: Test nginx config (CRITICAL -- do not skip)**
    ```bash
    sudo nginx -t
    ```
    If this reports errors, DO NOT proceed. Fix the config first or type the error here.

    **Step 4: Reload nginx**
    ```bash
    sudo systemctl reload nginx
    ```

    **Step 5: Test HTTP access**
    Visit http://coupe-des-montres.jimmydore.fr in a browser. You should see the game.

    **Step 6: Get SSL certificate**
    ```bash
    sudo certbot --nginx -d coupe-des-montres.jimmydore.fr
    ```
    Follow the prompts (typically just press Enter for defaults).

    **Step 7: Test HTTPS access**
    Visit https://coupe-des-montres.jimmydore.fr in a browser. You should see the game with a padlock icon.
  </instructions>
  <resume-signal>Type "done" when the site is live with HTTPS, or describe any errors encountered.</resume-signal>
</task>

<task type="auto">
  <name>Task 3: Verify full deployment pipeline end-to-end</name>
  <files></files>
  <action>
    After the user confirms VPS setup is complete, verify everything works:

    1. **Verify HTTPS works:**
       Run: `curl -sI https://coupe-des-montres.jimmydore.fr | head -20`
       Expect: HTTP 200, content-type text/html, presence of SSL headers.

    2. **Verify dotfiles are blocked:**
       Run: `curl -sI https://coupe-des-montres.jimmydore.fr/.git/HEAD`
       Expect: HTTP 404 (not 200).

    3. **Verify gzip is working:**
       Run: `curl -sH 'Accept-Encoding: gzip' -o /dev/null -w '%{size_download}' https://coupe-des-montres.jimmydore.fr/game.js`
       Compare with: `curl -s -o /dev/null -w '%{size_download}' https://coupe-des-montres.jimmydore.fr/game.js`
       Gzip response should be smaller.

    4. **Test deploy pipeline with a trivial change:**
       Make a small, harmless commit (e.g., add a comment to game.js or update a meta tag).
       Push to master: `git push origin master`
       Wait 30-60 seconds for GitHub Actions to run.
       Check the action ran: `gh run list --limit 1`
       Verify the change appeared on the live site.

    5. **Verify OG tags render:**
       Run: `curl -s https://coupe-des-montres.jimmydore.fr | grep 'og:'`
       Expect: All OG meta tags present in the response.

    If any check fails, investigate and fix. If the fix requires sudo on VPS, report it as a checkpoint for the user.
  </action>
  <verify>
    - `curl -sI https://coupe-des-montres.jimmydore.fr` returns 200
    - `curl -sI https://coupe-des-montres.jimmydore.fr/.git/HEAD` returns 404
    - `gh run list --limit 1` shows a successful deploy run
    - OG tags present in page source
  </verify>
  <done>
    Site is live at https://coupe-des-montres.jimmydore.fr with HTTPS.
    Dotfiles are blocked. Gzip is active.
    Push-to-deploy pipeline works end-to-end.
    OG meta tags are served for link previews.
  </done>
</task>

</tasks>

<verification>
Phase 3 success criteria from ROADMAP.md:
1. Visiting https://coupe-des-montres.jimmydore.fr on mobile Chrome loads and plays the game -- verified by curl 200 + user checkpoint
2. Pushing to master on GitHub triggers an automated deployment that updates the live site -- verified by test push + gh run list
3. The site serves over HTTPS with a valid SSL certificate -- verified by curl showing HTTPS 200 with SSL
</verification>

<success_criteria>
The game is live at https://coupe-des-montres.jimmydore.fr with a valid SSL certificate. Pushing to master triggers an automated deploy via GitHub Actions. Dotfiles (.git, .planning) are blocked by nginx. OG tags enable nice link previews when sharing via WhatsApp/iMessage.
</success_criteria>

<output>
After completion, create `.planning/phases/03-ship-it/03-02-SUMMARY.md`
</output>
