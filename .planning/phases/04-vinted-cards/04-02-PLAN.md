---
phase: 04-vinted-cards
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified: [game.js]
autonomous: false

must_haves:
  truths:
    - "Each watch flies across the screen as a white rounded-rectangle card with a watch illustration and brand name clearly readable at a glance"
    - "Slashing a card splits it into two tumbling halves that fall off-screen with the same satisfying feel as v1.0"
    - "Fake cards are visually identical to real cards -- only the brand spelling reveals the difference"
    - "Golden jackpot cards are visually distinct (gold background) and still trigger the jackpot bonus"
    - "Cards fly, rotate gently, and respond to the existing physics system without framerate drops on mobile"
  artifacts:
    - path: "game.js"
      provides: "Complete card integration: spawning, collision, split halves, decorative cards"
      contains: "createCardSprite"
  key_links:
    - from: "spawnWatch()"
      to: "createCardSprite()"
      via: "Sprite creation at spawn time"
      pattern: "createCardSprite"
    - from: "renderHalf()"
      to: "card.sprite"
      via: "drawImage blit with clip for split halves"
      pattern: "drawImage.*sprite"
    - from: "checkSlashCollisions()"
      to: "Math.max.*width.*height"
      via: "Circle approximation of card rectangle"
      pattern: "Math\\.max.*width.*height"
---

<objective>
Integrate the card rendering system into spawning, collision detection, split halves, and decorative watches so the complete game plays with Vinted-style cards.

Purpose: Plan 04-01 created the drawing functions. This plan wires them into all the game systems so cards actually appear, fly, get slashed, and split correctly.
Output: Fully playable game with Vinted-style cards replacing all watch visuals. Human verification at the end.
</objective>

<execution_context>
@/Users/jimmydore/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jimmydore/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-vinted-cards/04-RESEARCH.md
@.planning/phases/04-vinted-cards/04-01-SUMMARY.md
@game.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate cards into spawning, collision, split halves, and decorative watches</name>
  <files>game.js</files>
  <action>
  Wire the card rendering system into all game systems:

  **1. Update `spawnWatch()` function:**
  - Replace `var watchSize = isGolden ? WATCH_SIZE * 1.2 : WATCH_SIZE;` with:
    ```javascript
    var cardW = isGolden ? CARD_WIDTH * 1.15 : CARD_WIDTH;
    var cardH = isGolden ? CARD_HEIGHT * 1.15 : CARD_HEIGHT;
    ```
  - Remove `style: style` from the watch object (no more WATCH_STYLES)
  - Remove the `var style = WATCH_STYLES[...]` line
  - Add `width: cardW, height: cardH` to the watch object
  - Add `price: (5 + Math.floor(Math.random() * 45))` to the watch object (decorative price 5-49 EUR)
  - Keep `size` property but set it to `Math.max(cardW, cardH)` for backward compatibility with off-screen cleanup checks
  - Reduce rotation speed: change `(Math.random() - 0.5) * 3` to `(Math.random() - 0.5) * 0.5` (gentle wobble for readability)
  - After creating the watch object, call `createCardSprite(watch)` to pre-render the card
  - Remove the `sneaky` property from the watch object entirely. All fakes now look identical to reals (white card, only brand text differs). The `sneaky` concept is obsolete -- cards solve readability, making color-based deception unnecessary.

  **2. Update `checkSlashCollisions()` collision detection:**
  - Replace `var hitRadius = w.size / 2 * 1.2;` with `var hitRadius = Math.max(w.width, w.height) / 2 * 1.1;`
  - This keeps the circle approximation but sizes it to the card's largest dimension

  **3. Update `createSplitHalves()` function:**
  - Each half now needs `width`, `height`, `sprite`, `spritePadding` from the original watch (instead of `style`)
  - Remove `style: watch.style` from both halves
  - Remove `sneaky: watch.sneaky` from both halves
  - Add `width: watch.width, height: watch.height, sprite: watch.sprite, spritePadding: watch.spritePadding` to both halves
  - Keep `size` for backward compatibility with off-screen cleanup

  **4. Rewrite `renderHalf()` function:**
  - Replace the current body that creates a tempWatch and dispatches to drawRoundWatch/drawSquareWatch/drawSportWatch
  - New approach: save -> translate -> rotate -> globalAlpha -> clip to one side -> drawImage blit of half.sprite -> restore
  - Clip logic: for card aspect ratio, use `var clipW = half.width + half.spritePadding * 2; var clipH = half.height + half.spritePadding * 2;`
  - For 'right' clipSide: `ctx.rect(0, -clipH, clipW, clipH * 2)`
  - For 'left' clipSide: `ctx.rect(-clipW, -clipH, clipW, clipH * 2)`
  - Blit: `ctx.drawImage(half.sprite, 0, 0, half.sprite.width, half.sprite.height, -half.width/2 - p, -half.height/2 - p, half.width + p*2, half.height + p*2)` where p = half.spritePadding

  **5. Update `initDecorWatches()` for start screen:**
  - Remove `style: WATCH_STYLES[...]` from decorative watch objects
  - Remove `sneaky: false` -- no longer used
  - Add `width: CARD_WIDTH * (0.8 + Math.random() * 0.4), height: CARD_HEIGHT * (0.8 + Math.random() * 0.4)` (varied sizes)
  - Add `price: (5 + Math.floor(Math.random() * 45))` for the decorative price
  - Add `isGolden: false` to each decorative watch
  - After creating each decorative watch, call `createCardSprite(decorWatch)` to pre-render
  - Change `size:` to use `Math.max` of width/height for consistency

  **6. Update `drawWatch()` to use `drawCard()`:**
  - This was partially done in Plan 01. Verify that `drawWatch()` now just calls `drawCard(ctx, watch)`.
  - If Plan 01 left `drawWatch` with old caseColor logic, replace with the clean delegation: `drawCard(ctx, watch)`.

  **7. Remove all `sneaky` references throughout game.js:**
  - `spawnWatch()`: remove `sneaky` property and the `var sneaky = isFake && Math.random() < sneakyChance;` line
  - `getDifficulty()`: remove `sneakyChance` from the returned object
  - `createSplitHalves()`: remove `sneaky: watch.sneaky` from both halves
  - Cards make the "sneaky" concept obsolete: all cards are white regardless of real/fake, and the player must READ the brand name to tell the difference. This is the whole point of the card redesign.

  **8. Verify WATCH_SIZE is still used:**
  - `WATCH_SIZE` constant (line 72) may still be referenced. If only used for `watchSize` in spawnWatch (now replaced), it can stay as a dead constant or be removed. Check all references. If decorative watches used it for `size`, update those to use CARD_WIDTH/CARD_HEIGHT instead.

  **IMPORTANT constraints:**
  - Split halves reference the SAME sprite object as the original card (no copy). This is critical for memory efficiency.
  - The `sneaky` removal means ALL fakes are now visually identical to reals (white cards). The difficulty comes entirely from brand name readability.
  - Rotation speed MUST be reduced to `(Math.random() - 0.5) * 0.5` so brand names stay readable during flight.
  </action>
  <verify>
  - Open the game in a browser (or local server): cards should appear as white rounded rectangles with watch icons and brand names
  - `grep -c "sneaky" game.js` returns 0 (all sneaky references removed)
  - `grep -c "WATCH_STYLES\|drawRoundWatch\|drawSquareWatch\|drawSportWatch" game.js` returns 0
  - `grep "rotationSpeed" game.js` shows `0.5` max range (gentle wobble)
  - `grep "createCardSprite" game.js` shows calls in both spawnWatch and initDecorWatches
  </verify>
  <done>
  Cards are fully integrated: spawnWatch creates card sprites at spawn time, collision uses card dimensions, split halves blit the same cached sprite with clipping, decorative watches on start screen render as cards, rotation is gentle for readability, and all sneaky/style references are removed.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete Vinted card visual redesign. Watches now appear as white rounded-rectangle cards with a watch icon, bold brand name, and decorative price. Golden cards have gold background. Cards split into two tumbling halves when slashed. Fake cards look identical to real cards (only brand spelling differs).</what-built>
  <how-to-verify>
  1. Open the game on mobile Chrome (or desktop with mobile viewport) at the local dev server or coupe-des-montres.jimmydore.fr
  2. **Start screen:** Verify decorative cards are visible in the background (white rounded rectangles, not circles)
  3. **Press "Jouer"** and play for 10-15 seconds:
     - Cards should fly up from the bottom as white rectangles with a watch icon, brand name, and small price
     - Brand names should be clearly readable at a glance ("Montignac" vs fakes like "Montignak")
     - Cards should wobble gently, not spin wildly
  4. **Slash a card:** It should split into two tumbling halves that fall off-screen with fade-out
  5. **Watch for a golden card** (rare, 3%): Should have a gold background, visually distinct from white cards
  6. **Check performance:** No stuttering or frame drops, especially on mobile
  7. **Verify no visual glitches:** No shadow clipping, no blurry cards, no seam at the split line
  </how-to-verify>
  <resume-signal>Type "approved" if cards look good and feel satisfying, or describe any issues (readability, sizing, split feel, performance)</resume-signal>
</task>

</tasks>

<verification>
1. Game loads and plays with card visuals (no circles/old watch styles visible anywhere)
2. Brand names are clearly readable on mobile at gameplay speed
3. Slashing cards produces two tumbling halves (same satisfying feel as v1.0)
4. Golden cards are visually distinct (gold background)
5. Fake cards are visually identical to real cards (white cards, only brand differs)
6. No performance degradation on mobile (pre-rendered sprites should be faster than v1.0)
7. Start screen decorative watches render as cards
8. No JavaScript errors in console
</verification>

<success_criteria>
- Phase 4 success criteria #1: Each watch flies as a white rounded-rectangle card with watch illustration and brand name clearly readable
- Phase 4 success criteria #2: Slashing a card splits it into two tumbling halves with satisfying feel
- Phase 4 success criteria #3: Fake cards visually identical to real, only brand spelling differs
- Phase 4 success criteria #4: Golden jackpot cards visually distinct (gold color)
- Phase 4 success criteria #5: Cards fly and respond to physics without framerate drops on mobile
</success_criteria>

<output>
After completion, create `.planning/phases/04-vinted-cards/04-02-SUMMARY.md`
</output>
