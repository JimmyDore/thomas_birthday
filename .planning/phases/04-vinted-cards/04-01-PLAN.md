---
phase: 04-vinted-cards
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [game.js]
autonomous: true

must_haves:
  truths:
    - "Cards render as white rounded rectangles with a watch icon, bold brand name, and decorative price"
    - "Golden cards render with gold gradient background and darker brand text"
    - "Card sprites are pre-rendered to offscreen canvases (no per-frame shadowBlur)"
    - "Old watch drawing functions (drawRoundWatch, drawSquareWatch, drawSportWatch, drawBrandLabel) are removed"
  artifacts:
    - path: "game.js"
      provides: "drawCardToCanvas, drawWatchIcon, createCardSprite, drawCard functions"
      contains: "drawCardToCanvas"
  key_links:
    - from: "createCardSprite()"
      to: "drawCardToCanvas()"
      via: "Offscreen canvas rendering at spawn time"
      pattern: "drawCardToCanvas.*offCtx"
    - from: "drawCard()"
      to: "card.sprite"
      via: "drawImage blit of pre-rendered sprite"
      pattern: "drawImage.*sprite"
---

<objective>
Replace the three watch drawing styles (round, square, sport) with a single Vinted-style card rendering system using pre-rendered offscreen canvas sprites.

Purpose: Cards are the visual foundation for all of Phase 04. The new drawing functions must exist before spawning, collision, and split logic can be updated.
Output: Four new functions (drawCardToCanvas, drawWatchIcon, createCardSprite, drawCard) replace four old ones (drawRoundWatch, drawSquareWatch, drawSportWatch, drawBrandLabel) plus WATCH_STYLES array.
</objective>

<execution_context>
@/Users/jimmydore/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jimmydore/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-vinted-cards/04-RESEARCH.md
@game.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add card rendering functions and remove old watch styles</name>
  <files>game.js</files>
  <action>
  Replace the watch drawing system with a card sprite system. Specifically:

  **REMOVE these functions/constants entirely:**
  - `WATCH_STYLES` array (line 93) -- cards have one universal layout
  - `drawRoundWatch()` (lines 669-724)
  - `drawSquareWatch()` (lines 727-805)
  - `drawSportWatch()` (lines 808-870)
  - `drawBrandLabel()` (lines 873-884)
  - `darkenColor()` (lines 887-895) -- only used by drawSportWatch

  **ADD these new functions in the same section (between particle rendering and trail code):**

  1. `drawWatchIcon(ctx, cx, cy, r, isGolden)` (~20 lines)
     - Simplified watch illustration: colored case circle, cream dial, two hour markers (12 and 6), two hands, no crown/band
     - Case color: `#2a7d4f` (green) for normal, `#B8860B` (dark gold) for golden
     - Dial: `#f5f0e8` cream at 75% of radius
     - Keep it simple -- this is a small icon inside a card, not a standalone watch

  2. `drawCardToCanvas(offCtx, ox, oy, card)` (~40 lines)
     - Draws a complete Vinted-style listing card onto an offscreen canvas context
     - Card body: white (`#ffffff`) rounded rectangle, or gold gradient (`#DAA520` to `#FFD700`) for golden cards. Corner radius 8px.
     - Drop shadow: `shadowColor: rgba(0,0,0,0.25)`, `shadowBlur: 6`, `shadowOffsetY: 3` -- OK here because this runs ONCE at spawn, not per frame
     - After shadow, reset `shadowColor` to `transparent` before drawing inner content
     - Thin border: `#e0e0e0` for white cards, `#B8860B` for golden
     - Watch icon: call `drawWatchIcon()` centered in top 60% of card
     - Brand name: bold sans-serif, font size `Math.max(12, Math.min(16, card.width * 0.18))`, centered at 75% height. Color `#333` for white cards, `#5D4037` for golden.
     - Price tag: `10px sans-serif`, decorative, centered at 90% height. Color `#007782` (Vinted teal) for white, `#8B6914` for golden. Format: `card.price + ' EUR'`
     - Use native `ctx.roundRect()` for card body (Chrome 99+, our target)

  3. `createCardSprite(card)` (~15 lines)
     - Creates an offscreen canvas with padding (10px for shadow bleed)
     - Sizes at `(card.width + padding*2) * dpr` for DPR-aware sharp rendering
     - Scales the offscreen context by `dpr`
     - Calls `drawCardToCanvas()` once
     - Stores result on `card.sprite` and `card.spritePadding`

  4. `drawCard(ctx, card)` (~12 lines)
     - Replaces `drawWatch()` as the main per-frame rendering function
     - `ctx.save()` -> translate to card.x,y -> rotate by card.rotation -> `ctx.drawImage()` blit of cached sprite -> `ctx.restore()`
     - The drawImage call maps from full sprite canvas (0,0,sprite.width,sprite.height) to destination rect centered on (0,0) accounting for padding

  **MODIFY `drawWatch()`:**
  - Replace the entire body with a single call to `drawCard(ctx, watch)`. The function name stays for now (it is called in render loop and renderHalf) but internally just delegates to drawCard.
  - Remove the style dispatch (if round/square/sport) and caseColor logic -- drawCard handles everything via the sprite.

  **Card constants to add near the top (replacing WATCH_STYLES):**
  ```javascript
  var CARD_WIDTH = 80;
  var CARD_HEIGHT = 110;
  ```

  **IMPORTANT constraints:**
  - Do NOT add `shadowBlur` anywhere in the main render loop -- only in `drawCardToCanvas()` which runs once per spawn
  - Do NOT create separate functions for white vs golden cards -- `drawCardToCanvas` handles both via `card.isGolden`
  - Keep `darkenColor` ONLY if needed elsewhere (it is not -- remove it)
  - The `roundRect()` helper (line 965) stays for UI pills. Use native `ctx.roundRect()` for cards.
  </action>
  <verify>
  - Open game.js and confirm: no `drawRoundWatch`, `drawSquareWatch`, `drawSportWatch`, `drawBrandLabel`, `darkenColor`, or `WATCH_STYLES` references remain
  - Confirm `drawCardToCanvas`, `drawWatchIcon`, `createCardSprite`, `drawCard` all exist
  - Confirm `shadowBlur` only appears inside `drawCardToCanvas` (offscreen rendering), never in main render functions
  - Confirm `CARD_WIDTH` and `CARD_HEIGHT` constants exist
  </verify>
  <done>
  New card rendering system is in game.js: drawCardToCanvas renders a Vinted-style card to an offscreen canvas with shadow, watch icon, brand name, and price. createCardSprite caches the result. drawCard blits the cached sprite per frame. Old watch style functions are deleted. No shadowBlur in the main render loop.
  </done>
</task>

</tasks>

<verification>
1. `grep -c "drawRoundWatch\|drawSquareWatch\|drawSportWatch\|drawBrandLabel\|WATCH_STYLES" game.js` returns 0
2. `grep -c "drawCardToCanvas\|createCardSprite\|drawCard\|drawWatchIcon" game.js` returns 4+ (function definitions)
3. `grep "shadowBlur" game.js` only appears inside drawCardToCanvas function body
4. `grep "CARD_WIDTH\|CARD_HEIGHT" game.js` shows both constants defined
</verification>

<success_criteria>
- Card rendering functions exist and are syntactically correct
- Old watch drawing functions are completely removed
- No per-frame shadow rendering anywhere in the codebase
- Card dimensions are defined as tunable constants
</success_criteria>

<output>
After completion, create `.planning/phases/04-vinted-cards/04-01-SUMMARY.md`
</output>
