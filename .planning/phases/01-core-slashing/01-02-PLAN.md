---
phase: 01-core-slashing
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified: [game.js]
autonomous: false

must_haves:
  truths:
    - "Watches launch from the bottom of the screen in parabolic arcs and fall off-screen with gravity"
    - "Three visually distinct watch styles (round, square, sport) appear with brand name labels"
    - "Swiping across a watch splits it into two tumbling halves with colored particle burst (green for real Montignac, red for fake)"
    - "Slashing a real Montignac adds 15EUR, slashing a fake subtracts 8EUR, missing a real Montignac subtracts 5EUR"
    - "Running profit is displayed in the top corner and updates in real time"
    - "Floating +15EUR / -8EUR / -5EUR text appears at the slash/miss point and fades upward"
    - "Haptic vibration fires on each slash (Chrome Android)"
    - "All displayed text is in French"
  artifacts:
    - path: "game.js"
      provides: "Watch spawning, physics, 3 watch drawing styles, slash detection, split animation, particles, floating text, scoring, haptic feedback"
      min_lines: 400
      contains: "drawWatch"
  key_links:
    - from: "game.js (spawnWatch)"
      to: "game.js (watches array)"
      via: "Push new watch entity with physics properties"
      pattern: "watches\\.push"
    - from: "game.js (checkSlashCollisions)"
      to: "game.js (lineSegmentIntersectsCircle)"
      via: "Line-segment-to-circle collision for each trail segment against each watch"
      pattern: "lineSegmentIntersectsCircle"
    - from: "game.js (slashWatch)"
      to: "game.js (createSplitHalves + spawnParticles + spawnFloatingText + hapticFeedback)"
      via: "Slash event triggers split, particles, score text, and vibration"
      pattern: "createSplitHalves"
    - from: "game.js (entity cleanup)"
      to: "game.js (score penalty for missed real watches)"
      via: "Off-screen check triggers -5EUR penalty for unslashed real watches"
      pattern: "missedPenalty"
---

<objective>
Add all gameplay entities and mechanics to the game shell from Plan 01: watches fly in parabolic arcs, the player slashes them by swiping, watches split into tumbling halves with particle bursts, and the score tracks profit in euros. Real Montignac watches earn money, fakes lose money, and missing a real watch costs money too.

Purpose: This completes Phase 1 -- after this plan, the core slashing gameplay loop is fully playable on mobile. A player can swipe watches, see satisfying split animations, and track their profit.

Output: Updated game.js with complete gameplay mechanics.
</objective>

<execution_context>
@/Users/jimmydore/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jimmydore/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-core-slashing/01-CONTEXT.md
@.planning/phases/01-core-slashing/01-RESEARCH.md
@.planning/phases/01-core-slashing/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Watch spawning, drawing (3 styles), physics, and entity cleanup</name>
  <files>game.js</files>
  <action>
Add to game.js (extending the foundation from Plan 01):

**Watch state arrays:**
- `const watches = [];` -- active watch entities
- `const splitHalves = [];` -- split watch halves after slash
- `let spawnTimer = 0;` -- accumulator for spawn interval
- `const SPAWN_INTERVAL = 1.2;` -- seconds between spawns (fixed for Phase 1, no difficulty ramp)
- `const GRAVITY = 600;` -- pixels/sec^2
- `const WATCH_SIZE = 60;` -- diameter in CSS pixels

**Watch spawning (spawnWatch function):**
- Launch from bottom of screen (y = canvasHeight + 50, below visible area)
- X position: randomly in left or right third of screen (avoid center-only spawns that feel monotonous)
  - Left spawn: `canvasWidth * (0.1 + Math.random() * 0.3)`, vx = `30 + Math.random() * 80` (rightward)
  - Right spawn: `canvasWidth * (0.6 + Math.random() * 0.3)`, vx = `-(30 + Math.random() * 80)` (leftward)
- Vertical velocity: `vy = -(450 + Math.random() * 200)` (strong upward launch)
- 40% chance of being fake (`isFake = Math.random() < 0.4`)
- Fake brand names: randomly pick from `['Montignak', 'Montinyac', 'Montiganc', 'Montigniak', 'Montignaq']`
- Real brand: always `'Montignac'`
- Watch style: randomly pick from `['round', 'square', 'sport']`
- Rotation: `rotationSpeed = (Math.random() - 0.5) * 3` radians/sec
- Value: `isFake ? -8 : 15` (euros)
- Sneaky fakes (per CONTEXT.md): ~30% of fakes use the SAME green color as real watches (only the misspelled name distinguishes them). Set a `sneaky` boolean flag. The other 70% of fakes use red color.
- Push the entity object to `watches` array with all properties: `{ x, y, vx, vy, size, rotation, rotationSpeed, isFake, sneaky, brand, style, slashed: false, value }`

**Spawn timer in update(dt):**
- `spawnTimer += dt; if (spawnTimer >= SPAWN_INTERVAL) { spawnTimer -= SPAWN_INTERVAL; spawnWatch(canvasWidth, canvasHeight); }`

**Watch physics update (updateWatches function):**
- For each watch: `w.vy += GRAVITY * dt; w.x += w.vx * dt; w.y += w.vy * dt; w.rotation += w.rotationSpeed * dt;`
- Entity cleanup: if watch is off-screen (y > canvasHeight + 100 and vy > 0, meaning it fell below the screen), remove it
- **Missed penalty (CRITICAL):** Before removing an off-screen watch, check `if (!w.slashed && !w.isFake)` -- this is a real Montignac that was missed. Apply penalty: `score -= 5; spawnFloatingText(w.x, canvasHeight - 30, -5, false, true);` (the `true` flag means "missed" for different coloring). Per CONTEXT.md: "Missing a real Montignac (falls off screen) costs money."
- Also remove watches that go too far left/right (x < -200 or x > canvasWidth + 200)

**Watch drawing (drawWatch function):**
- Takes `ctx, x, y, size, brand, isFake, sneaky, style`
- Determine case color: real watches = `#2a7d4f` (green). Non-sneaky fakes = `#cc3333` (red). Sneaky fakes = same `#2a7d4f` as real (player must read the name!)
- `ctx.save(); ctx.translate(x, y); ctx.rotate(watch.rotation);`

- **Round Classic style (style === 'round'):**
  - Circular case: `ctx.arc(0, 0, r, 0, Math.PI * 2)`, filled with case color, stroked dark
  - Cream dial inner circle: `ctx.arc(0, 0, r * 0.75, ...)`, filled `#f5f0e8`
  - 4 hour markers at 12, 3, 6, 9 positions (small squares)
  - Hour and minute hands (two lines from center)
  - Crown: small circle at right edge
  - Lugs: small rectangles at top and bottom
  - Band stubs: rectangles extending from lugs, brown `#8B4513`

- **Square Cushion style (style === 'square'):**
  - Rounded rectangle case (use manual path with arc corners since roundRect may not be available everywhere): similar proportions but square shape
  - Same cream dial (but square-ish), same hour markers, same hands
  - Wider lugs, silver/metal bracelet stubs `#aaa` instead of brown leather

- **Sport Diver style (style === 'sport'):**
  - Circular case like Round but with a thicker bezel ring (concentric circle, slightly darker than case color)
  - Same cream dial, same markers, same hands
  - Larger crown (bigger circle)
  - Chunky rubber band stubs `#333` instead of brown leather

- **Brand name label on ALL styles:**
  - `ctx.font = \`bold \${Math.max(10, size * 0.18)}px sans-serif\``
  - Dark text `#333` on the cream dial, centered, positioned at `y = r * 0.3`
  - Min font size 10px per research pitfall guidance (readability at speed)

- `ctx.restore()`

**Watch rendering in render function:**
- After background, before trail: iterate `watches` and call `drawWatch` for each (with its current rotation applied via `ctx.rotate`)
- After trail rendering: render split halves (above trail for visual hierarchy)

**Wire into game loop:**
- `update(dt)` calls: `updateTrail()`, spawn timer logic, `updateWatches(dt)`
- `render()` calls: `renderBackground()`, render watches, `renderTrail()`, render split halves (Task 2), render particles (Task 2), render floating texts (Task 2), `renderScore()`
  </action>
  <verify>
Open index.html in browser. Verify:
1. Watches launch from below the screen every ~1.2 seconds
2. They arc upward, hang briefly near the apex, then fall back down with gravity
3. Three distinct watch styles appear (round, square, sport) with visible differences
4. Each watch shows a brand name label on the dial
5. ~60% of watches are green (real Montignac or sneaky fakes), ~40% are red (obvious fakes), with some green watches having misspelled names
6. Watches that fall off the bottom of the screen are removed
7. Score decreases by 5 when a real Montignac falls off screen (check console log or watch the score display)
8. No console errors, smooth 60fps
  </verify>
  <done>
Watches spawn from below, arc upward in parabolic trajectories, display brand names on three distinct watch silhouettes, and fall off screen with gravity. Real missed watches trigger a -5EUR penalty. Green/red color coding and sneaky fakes work correctly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Slash detection, split animation, particles, floating text, and scoring</name>
  <files>game.js</files>
  <action>
Add to game.js:

**Additional state arrays (at the top with other state):**
- `const particles = [];` -- particle burst entities
- `const floatingTexts = [];` -- floating score text entities

**Line-segment-to-circle collision (lineSegmentIntersectsCircle function):**
- Exact algorithm from research: projection-clamping approach
- Parameters: `ax, ay, bx, by, cx, cy, r` (line segment A-B, circle center C, radius r)
- Handle degenerate segment (length 0): check point-in-circle
- Project circle center onto line segment, clamp t to [0, 1]
- Compute nearest point on segment to circle center
- Return `distanceSquared <= r * r`

**Slash detection (checkSlashCollisions function):**
- Called from `update(dt)` AFTER trail update, BEFORE watch physics update
- Only check if `trailPoints.length >= 2`
- Only check the most recent 5-6 trail segments (performance optimization): `const start = Math.max(0, trailPoints.length - 6)`
- For each consecutive pair of recent trail points, for each watch that is NOT `slashed`:
  - Hit radius: `watch.size / 2 * 1.2` (20% generous hitbox for good game feel)
  - If `lineSegmentIntersectsCircle(p0.x, p0.y, p1.x, p1.y, w.x, w.y, hitRadius)`:
    - Call `slashWatch(w, slashAngle)` where slashAngle = `Math.atan2(p1.y - p0.y, p1.x - p0.x)`

**Slash event handler (slashWatch function):**
- Mark `watch.slashed = true` IMMEDIATELY (prevents double-detection per Pitfall 5)
- Update score: `score += watch.value` (positive for real, negative for fake)
- Create split halves: `splitHalves.push(...createSplitHalves(watch, slashAngle))`
- Spawn particles: `spawnParticles(watch.x, watch.y, watch.isFake, 12)`
- Spawn floating text: `spawnFloatingText(watch.x, watch.y, watch.value, watch.isFake, false)`
- Haptic feedback: `hapticFeedback(30)`
- Remove the watch from the `watches` array

**Split half creation (createSplitHalves function):**
- Takes `watch, slashAngle`
- Returns array of 2 half objects: left half and right half
- Each half has: `x, y, vx, vy, rotation, rotationSpeed, size, brand, isFake, sneaky, style, clipSide ('left'/'right'), alpha: 1.0, life: 1.0, age: 0`
- Perpendicular angle: `slashAngle + Math.PI / 2`
- Push velocity: 80 px/sec outward (left half gets +perpendicular, right gets -perpendicular)
- Rotation speed: left = `-(3 + Math.random() * 4)`, right = `3 + Math.random() * 4` (tumble apart)
- Inherit watch's existing velocity

**Split half physics (updateSplitHalves function):**
- For each half: apply gravity to vy, update x/y, update rotation, advance age, fade alpha: `h.alpha = Math.max(0, 1 - h.age / h.life)`
- Remove when `age >= life` or off-screen

**Split half rendering (renderHalf function):**
- `ctx.save(); ctx.translate(h.x, h.y); ctx.rotate(h.rotation); ctx.globalAlpha = h.alpha;`
- Clip to one side: `ctx.beginPath(); ctx.rect(clipSide === 'right' ? 0 : -large, -large, large, large * 2); ctx.clip();`
- Draw the full watch using `drawWatch` (only the clipped half will be visible)
- `ctx.restore()` -- CRITICAL to prevent clip() state leak (Pitfall 3)

**Particle system (spawnParticles, updateParticles, renderParticles):**
- Spawn: 10-12 particles per slash at the watch position
  - Color: `isFake ? '220, 50, 50' : '50, 180, 80'` (red or green per CONTEXT.md)
  - Random radial velocity: 50-200 px/sec, slight upward bias (vy - 50)
  - Radius: 2-5px random
  - Lifetime: 0.4-0.7 seconds
  - Hard cap: if `particles.length > 200`, skip spawning (Pitfall 4)
- Update: apply gravity (400 px/sec^2), drag (vx *= 0.98), advance age, fade alpha, remove expired (backward iteration with splice)
- Render: for each particle, `ctx.arc(p.x, p.y, p.radius, ...)` filled with `rgba(color, alpha)`

**Floating text system (spawnFloatingText, updateFloatingTexts, renderFloatingTexts):**
- Spawn: at slash/miss position
  - Text: `(amount >= 0 ? '+' : '') + amount + '\u20AC'` (e.g., "+15EUR" or "-8EUR")
  - Color: `isFake ? '220, 50, 50' : '50, 180, 80'` for slashes. For missed watches (flag parameter), use `'220, 50, 50'` (red)
  - Float speed: -60 px/sec (upward)
  - Lifetime: 1.0 seconds
  - Hard cap: if `floatingTexts.length > 20`, remove oldest
- Update: move upward, advance age, fade alpha, remove expired
- Render: `ctx.font = 'bold 22px sans-serif'; ctx.textAlign = 'center'; ctx.fillText(ft.text, ft.x, ft.y);` with alpha

**Wire everything into the game loop:**
- `update(dt)` order: `updateTrail()`, spawn timer, `checkSlashCollisions()`, `updateWatches(dt)`, `updateSplitHalves(dt)`, `updateParticles(dt)`, `updateFloatingTexts(dt)`
- `render()` order: `renderBackground()`, render watches (iterate and draw each), `renderTrail()`, render split halves, `renderParticles()`, `renderFloatingTexts()`, `renderScore()`

**Scoring notes:**
- Real Montignac slashed: +15EUR (green floating text, green particles)
- Fake watch slashed: -8EUR (red floating text, red particles)
- Real Montignac missed (off-screen): -5EUR (red floating text at bottom of screen, no particles)
- Score can go negative (per CONTEXT.md: "going into debt is part of the joke")
  </action>
  <verify>
Open index.html in browser. Verify:
1. Swiping across a watch splits it into two tumbling halves that fall away
2. Green particle burst when slashing a real Montignac (green watch with correct name)
3. Red particle burst when slashing a fake (red watch or sneaky green with misspelled name)
4. "+15EUR" floats up in green at the slash point for real watches
5. "-8EUR" floats up in red at the slash point for fake watches
6. "-5EUR" appears at the bottom when a real Montignac falls off screen
7. Score updates correctly: increases for real, decreases for fake and missed
8. Score can go negative
9. Multiple rapid slashes work without double-counting
10. No visual glitches from clip() state leaks
11. Phone haptic vibration fires on slash (test on real Android Chrome device if available)
12. Smooth 60fps even with many particles on screen
  </verify>
  <done>
Complete slashing gameplay loop works: swipe to slash watches, watches split into tumbling halves with colored particle bursts, score tracks profit with floating text feedback, missed real watches cost money, haptic feedback fires. All text in French (euro signs, no English labels).
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete Phase 1 core slashing gameplay: watches fly in arcs, swipe to slash with gold trail, watches split with particles, score tracks profit in euros.</what-built>
  <how-to-verify>
1. Open the game on your phone (or use Chrome DevTools mobile emulation with `python3 -m http.server 8000`)
2. Verify the teal gradient fills the screen with no scroll or zoom
3. Watch for watches launching from the bottom in arcs -- you should see three different styles (round, square, sport)
4. Swipe across a watch -- it should split into two tumbling halves with a particle burst
5. Check green particles for real "Montignac" watches and red particles for fakes
6. Look for sneaky fakes: green watches with misspelled names (Montignak, etc.)
7. Let a real Montignac fall off screen -- score should decrease by 5EUR
8. Verify the score goes negative if you slash enough fakes
9. Check that the gold swipe trail is visible and fades smoothly
10. Overall: does it feel satisfying? Is it responsive? Are the watches readable?
  </how-to-verify>
  <resume-signal>Type "approved" to move on, or describe any issues to fix.</resume-signal>
</task>

</tasks>

<verification>
1. Watches spawn every ~1.2 seconds from the bottom of the screen
2. Three distinct watch styles appear with brand name labels on the dial
3. Watches arc upward in parabolic trajectories and fall with gravity
4. Swiping draws a gold fading trail and slashing a watch splits it with particles
5. Green particles for real Montignac, red particles for fakes
6. Sneaky fakes: green-colored watches with misspelled names exist
7. Score: +15EUR for real, -8EUR for fake, -5EUR for missed real
8. Floating score text appears at slash/miss point and fades upward
9. Score can go negative
10. Haptic vibration fires on slash (Chrome Android)
11. All displayed text is in French (EUR symbol, no English)
12. 60fps, no glitches, no unbounded arrays
</verification>

<success_criteria>
- Watches launch, arc, and fall with satisfying parabolic physics
- Three watch styles are visually distinct with readable brand labels
- Slash detection works reliably even for fast swipes
- Split animation shows two tumbling halves with colored particle burst
- Scoring is correct: +15 real, -8 fake, -5 missed
- Running profit display updates in real time
- Floating score text appears at slash/miss points
- Haptic feedback fires on slash
- No performance degradation over time
- Game feels satisfying to play on mobile
</success_criteria>

<output>
After completion, create `.planning/phases/01-core-slashing/01-02-SUMMARY.md`
</output>
